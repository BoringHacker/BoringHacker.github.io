<!DOCTYPE html>
<html lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
  
  <title itemprop="name">数据结构100题 21~30题 | BoringHacker&#39;s Blog</title>
  
    <link rel="shortcut icon" href="https://i.loli.net/2020/02/06/fvXuYw6p9PDCOR3.png">
  
  <meta http-equiv="x-dns-prefetch-control" content="on">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noto+SerifMerriweather|Merriweather+Sans|Source+Code+Pro|Ubuntu:400,700|Noto+Serif+SC" media="all">
  <link rel="dns-prefetch" href="//cdn.jsdelivr.net">
  <link rel="stylesheet" id="saukra_css-css" href="/css/style.css" type="text/css" media="all">
  <link rel="stylesheet" href="/css/lib.min.css" media="all">
  <link rel="stylesheet" href="/css/font.css" media="all">
  <link rel="stylesheet" href="/css/insight.css" media="all">
  <link rel="stylesheet" href="/css/jquery.fancybox.min.css" media="all">
  <link rel="stylesheet" href="/css/zoom.css" media="all">
    <style>
  .emoji-coda {
      display: inline-block !important;
      position: relative;
      width: 45px;
      top: 2px;
      margin: -3px 3px !important;
      padding: 0;
  }
  </style>

  <link rel="stylesheet" type="text/css" href="/css/sharejs.css">
<!--   <link rel="stylesheet" id="saukra_css-css" href="https://2heng.xin/wp-content/cache/autoptimize/css/autoptimize_ad42a61f4c7d4bdd9f91afcff6b5dda5.css
" type="text/css" media="all"> -->
  <script>
  /*Initial Variables*/
  var mashiro_option = new Object();
  var mashiro_global = new Object();
  mashiro_option.NProgressON = true;
  /* 
   * 邮箱信息之类的东西可以填在这里，这些js变量基本都作用于sakura-app.js
   * 这样的设置仅是为了方便在基于PHP开发的主题中设置js变量，既然移植到了Node上，我想或许可以精简这一逻辑吧
   */
  mashiro_option.email_domain = "";
  mashiro_option.email_name = "";
  mashiro_option.cookie_version_control = "";
  mashiro_option.qzone_autocomplete = false;
  mashiro_option.site_name = "BoringHacker'sBlog";
  mashiro_option.author_name = "Blog";
  mashiro_option.site_url = "https://www.orchid-any.cf/";
  mashiro_option.v_appId = "8Hho6gvnedMT9NMEhnEx3UOg-gzGzoHsz";
  mashiro_option.v_appKey = "gU70zYoblzxCmc6iL697pp69";
  mashiro_option.mathjax = "1";
  mashiro_option.qq_api_url = "https://api.mashiro.top/qqinfo/"; 
  mashiro_option.qq_avatar_api_url = "https://api.mashiro.top/qqinfo/";

  // mashiro_option.jsdelivr_css_src = "https://cdn.jsdelivr.net/gh/moezx/cdn@3.4.5/css/lib.min.css";
  // mashiro_option.float_player_on = true;

  /*End of Initial Variables*/
  </script>
  <script type="text/javascript">
  var bg = "https://i.loli.net/2020/02/06/QA9iLJO3bxechgl.jpg,https://i.loli.net/2020/02/06/y7XPcCUKonORjNf.jpg,https://i.loli.net/2020/02/06/x5iQL7yYCS6s4aN.jpg,https://i.loli.net/2020/02/06/ASPhQ5EZOHjy4m2.jpg,https://i.loli.net/2020/02/06/vChPneTKf6xF7dw.jpg,https://i.loli.net/2020/02/06/ciZsjA4hQEqYvUk.jpg,https://i.loli.net/2020/02/06/ymPMJQchwzRLBCl.jpg,https://i.loli.net/2020/02/06/FulkGY4BE175moj.jpg".split(",");
  var bgindex = Math.floor(Math.random()*bg.length);
  if (!!window.ActiveXObject || "ActiveXObject" in window) { //is IE?
    alert('朋友，IE浏览器未适配哦~');
  }
  </script>
  <style type="text/css">
  .hljs-ln{border-collapse:collapse}.hljs-ln td{padding:0}.hljs-ln-n:before{content:attr(data-line-number)}
  </style>
  <style type="text/css">.site-top .lower nav{display:block !important;}.author-profile i,.post-like a,.post-share .show-share,.sub-text,.we-info a,span.sitename,.post-more i:hover,#pagination a:hover,.post-content a:hover,.float-content i:hover{color:#FE9600}.feature i,.download,.navigator i:hover,.links ul li:before,.ar-time i,span.ar-circle,.object,.comment .comment-reply-link,.siren-checkbox-radio:checked + .siren-checkbox-radioInput:after{background:#FE9600}::-webkit-scrollbar-thumb{background:#FE9600}.download,.navigator i:hover,.link-title,.links ul li:hover,#pagination a:hover,.comment-respond input[type='submit']:hover{border-color:#FE9600}.entry-content a:hover,.site-info a:hover,.comment h4 a,#comments-navi a.prev,#comments-navi a.next,.comment h4 a:hover,.site-top ul li a:hover,.entry-title a:hover,#archives-temp h3,span.page-numbers.current,.sorry li a:hover,.site-title a:hover,i.iconfont.js-toggle-search.iconsearch:hover,.comment-respond input[type='submit']:hover{color:#FE9600}.comments .comments-main{display:block !important;}.comments .comments-hidden{display:none !important;}background-position:center center;background-attachment:inherit;}
  </style>
</head>
</html>
<body class="page-template page-template-user page-template-page-analytics page-template-userpage-analytics-php page page-id-1297 chinese-font serif isWebKit">
   <div class="skin-menu no-select" id="mainskin" style="position: fixed;bottom:65px;left:31px;">
    <div class="theme-controls row-container">
          <p style="text-align:center;font-family:'Monaco';font-weight:bold;color:#444"><i style="color:grey" class="fa fa-chevron-left"></i> background <i style="color:grey" class="fa fa-chevron-right"></i></p>
        <ul class="menu-list"> <li id="white-bg"> 
            <i class="fa fa-television" aria-hidden="true">
            </i>
            </li> 
            <li id="sakura-bg"> 
                <i class="iconfont icon-sakura">
                </i>
            </li>
            <li id="gribs-bg">
                <i class="fa fa-slack" aria-hidden="true">
                </i>
            </li>
            <li id="KAdots-bg">
                <i class="iconfont icon-dots">
                </i>
            </li>
            <li id="totem-bg">
                <i class="fa fa-optin-monster" aria-hidden="true">
                </i>
            </li>
            <li id="pixiv-bg">
                <i class="iconfont icon-pixiv">
                </i>
            </li>
            <li id="bing-bg">
                <i class="iconfont icon-bing">
                </i>
            </li>
            <li id="dark-bg">
                <i class="fa fa-moon-o" aria-hidden="true">
                </i>
            </li>
        </ul>
    </div>
      <hr>
  <p style="text-align:center;font-family:'Monaco';font-weight:bold;color:#444"><i style="color:grey" class="fa fa-chevron-left"></i> font <i style="color:grey" class="fa fa-chevron-right"></i></p>
  <div class="font-family-controls row-container">
    <button type="button" class="control-btn-serif " data-mode="serif" onclick="mashiro_global.font_control.change_font()">Serif</button>
    <button type="button" class="control-btn-sans-serif" data-mode="sans-serif" onclick="mashiro_global.font_control.change_font()">Sans Serif</button>
  </div>
  <hr>
  <p style="text-align:center;font-family:'Monaco';font-weight:bold;color:#444"><i style="color:grey" class="fa fa-chevron-left"></i> script <i style="color:grey" class="fa fa-chevron-right"></i></p>
  <div class="theme-controls row-container">
  <ul class="menu-list">
    <li id="empty-effect">
      <i class="fa fa-ban">
      </i>
    </li>
    <li id="sakura-rain-effect">
      <i class="iconfont icon-sakura">
      </i>
    </li>
    <li id="snowy-effect">
      <i class="fa fa-snowflake-o">
      </i>
    </li>
    <li id="lines-effect">
      <i class="fa fa-chevron-left">
      </i>
    </li>
    <li id="colorful-belts-effect">
      <i class="fa fa-map"></i>
      </i>
    </li>
    <li id="words-rain-effect">
      <i class="fa fa-font"></i>
    </li>
    <li id="point-rain-effect">
      <i class="iconfont icon-dots"></i>
    </li>
    <li id="rain-drop-effect">
      <i class="fa fa-tint"></i>
    </li>
  </ul>
  </div>

    <canvas id="night-mode-cover">
    </canvas>
</div>
 
 <div class="changeSkin-gear no-select" style="background: rgba(0, 0, 0, 0) none repeat scroll 0% 0%; visibility: visible; bottom: 0px;"> 
  <div class="keys" id="setbtn"> 
    <button id="open-skinMenu">
        <style>
        button#open-skinMenu{
            transition: all 0.2s linear 0s;
            outline:none;
            position:fixed;
            bottom:13px;
            left:15px;
            font-size:16px;
            background-color: rgba(255,255,255,.95);
            border-radius: 20px;
            box-shadow: 0 3px 8px 0 rgba(0,0,0,0.1), 0 3px 8px 0 rgba(0,0,0,0.1);
        }
        button#open-skinMenu:hover{
            transition: all 0.2s linear 0s;
            background-color: rgb(255, 165, 0);
            color: rgba(255,255,255);
        }
        </style>
        <i class="iconfont icon-gear inline-block rotating">
      </i> 
        SCHEME TOOL | 主题工具 
    </button>
  </div> 
</div>


  <div class="scrollbar" id="bar">
  </div>
  <a href="#" class="cd-top faa-float animated"></a>
  <section id="main-container">
    <div class="headertop ">
  <div id="banner_wave_1"></div>
  <div id="banner_wave_2"></div>
  <figure id="centerbg" class="centerbg">
    <div class="focusinfo no-select">
      <div class="header-tou">
        <a href="https://www.orchid-any.cf/">
          <img src="https://i.loli.net/2020/02/06/fuc7zI8iylU5ANt.jpg">
        </a>
      </div>
      <div class="header-info">
        <p>Stay Hungry, Stay Foolish</p>
        <div class="top-social_v2">
          <li id="bg-pre">
            <img class="flipx" src="https://cdn.jsdelivr.net/gh/honjun/cdn@1.6/img/other/next-b.svg">
          </li>
          
            
              
                <li>
                  <a href="http://github.com/boringhacker" target="_blank" class="social-github" title="github">
                    <img src="https://i.loli.net/2020/02/06/JWRHC7AUqzseoDV.png">
                  </a>
                </li>
              
            
              
                <li>
                  <a href="https://music.163.com/#/user/home?id=1842865470" target="_blank" class="social-github" title="NetEase">
                    <img src="https://i.loli.net/2020/02/06/JA28YeoESRvpQZk.png">
                  </a>
                </li>
              
            
              
                <li>
                  <a href="https://www.zhihu.com/people/boringhacker" target="_blank" class="social-github" title="zhihu">
                    <img src="https://i.loli.net/2020/02/06/YzfiMGnHqW12Tp7.png">
                  </a>
                </li>
              
            
          
          <li id="bg-next">
            <img src="https://cdn.jsdelivr.net/gh/honjun/cdn@1.6/img/other/next-b.svg">
          </li>
        </div>
      </div>
    </div>
  </figure>
  <div id="video-container" style="">
    <video style="object-fit: fill" id="bgvideo" class="video" video-name="" src="" width="auto" preload="auto">
    </video>
    <!-- <div id="video-btn" class="loadvideo videolive">
    </div> -->
    <div id="video-add">
    </div>
    <div class="video-stu">
    </div>
  </div>
  <div class="headertop-down faa-float animated" onclick="headertop_down()">
    <span>
      <i class="fa fa-chevron-down" aria-hidden="true">
      </i>
    </span>
  </div>
</div>
    <div id="page" class="site wrapper">
      <header class="site-header no-select gizle sabit" role="banner">
  <div class="site-top">
    <div class="site-branding">
      <span class="site-title">
        <span class="logolink moe-mashiro">
          <a href="/">
            <!-- <span class="sakurasono">BoringHacker&#39;s</span>
            <span class="shironeko">Blog</span> -->
            <img src = https://i.loli.net/2020/02/06/hfRpABJw9jXScay.png>
          </a>
        </span>
      </span>
    </div>
    <div class="searchbox search-form-submit">
      <i class="iconfont js-toggle-search iconsearch icon-search">
      </i>
    </div>
    <div id="show-nav" class="showNav mobile-fit">
      <div class="line line1">
      </div>
      <div class="line line2">
      </div>
      <div class="line line3">
      </div>
    </div>
    <div class="lower-cantiner">
      <div class="lower">
        <nav class="mobile-fit-control hide">
          <ul id="menu-new" class="menu">
            
              <li>
                <a href="/">
                  <span class="faa-parent animated-hover">
                    <i class="fa  fa-fort-awesome faa-shake" aria-hidden="true"></i>
                    Home
                  </span>
                </a>
                
              </li>
            
              <li>
                <a href="/archives">
                  <span class="faa-parent animated-hover">
                    <i class="fa  fa-archive faa-shake" aria-hidden="true"></i>
                    Archives
                  </span>
                </a>
                
                  <ul class="sub-menu">
                    
                      <li>
                        <a href="/categories/Note/">
                          <i class="fa fa-book" aria-hidden="true"></i>
                          Notes
                        </a>
                      </li>
                    
                      <li>
                        <a href="/categories/Solution">
                          <i class="fa fa-code" aria-hidden="true"></i>
                          Solution
                        </a>
                      </li>
                    
                  </ul>
                
              </li>
            
              <li>
                <a href="javascript:;">
                  <span class="faa-parent animated-hover">
                    <i class="fa  fa-list-ul faa-vertical" aria-hidden="true"></i>
                    Lists
                  </span>
                </a>
                
                  <ul class="sub-menu">
                    
                      <li>
                        <a href="/tags/悦读/">
                          <i class="fa fa-th-list faa-bounce" aria-hidden="true"></i>
                          Books
                        </a>
                      </li>
                    
                      <li>
                        <a href="/bangumi/">
                          <i class="fa fa-film faa-vertical" aria-hidden="true"></i>
                          Animes
                        </a>
                      </li>
                    
                  </ul>
                
              </li>
            
              <li>
                <a href="/comment/">
                  <span class="faa-parent animated-hover">
                    <i class="fa  fa-pencil-square-o faa-tada" aria-hidden="true"></i>
                    Comments
                  </span>
                </a>
                
              </li>
            
              <li>
                <a href="/links/">
                  <span class="faa-parent animated-hover">
                    <i class="fa  fa-link faa-shake" aria-hidden="true"></i>
                    Links
                  </span>
                </a>
                
              </li>
            
              <li>
                <a href="/Tools/">
                  <span class="faa-parent animated-hover">
                    <i class="fa  fa-cog" aria-hidden="true"></i>
                    Tools
                  </span>
                </a>
                
              </li>
            
              <li>
                <a href="/tags/">
                  <span class="faa-parent animated-hover">
                    <i class="fa  fa-tags" aria-hidden="true"></i>
                    Tags
                  </span>
                </a>
                
              </li>
            
              <li>
                <a href="/">
                  <span class="faa-parent animated-hover">
                    <i class="fa  fa-leaf faa-wrench" aria-hidden="true"></i>
                    About
                  </span>
                </a>
                
                  <ul class="sub-menu">
                    
                      <li>
                        <a href="/about/">
                          <i class="fa fa-meetup" aria-hidden="true"></i>
                          Me
                        </a>
                      </li>
                    
                      <li>
                        <a href="/lab/">
                          <i class="fa fa-cogs" aria-hidden="true"></i>
                          Blog
                        </a>
                      </li>
                    
                  </ul>
                
              </li>
            
              <li>
                <a href="/atom.xml">
                  <span class="faa-parent animated-hover">
                    <i class="fa  fa-rss faa-pulse" aria-hidden="true"></i>
                    RSS
                  </span>
                </a>
                
              </li>
            
          </ul>
        </nav>
      </div>
    </div>
  </div>
</header>

      <link rel="stylesheet" type="text/css" href="/css/sharejs.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.css">
<div class="pattern-center-blank"></div>
<script>
var spoiler=document.getElementsByClassName('spoiler');
for(var i=0;i<spoiler.length;++i)
spoiler[i].onclick=function(){this.classList.toggle("revealed");};
</script>

  <div class="pattern-center-sakura single-center">
    <!-- 有配图默认渲染第一张 -->
    <div class="pattern-attachment-img lazyload" style="background-image: url(https://i.loli.net/2020/02/08/iXSqlWCpTkrsDt6.jpg);" src="https://cdn.jsdelivr.net/gh/honjun/cdn@1.6/img/loader/orange.progress-bar-stripe-loader.svg" data-src="https://i.loli.net/2020/02/08/iXSqlWCpTkrsDt6.jpg">
    </div>
    <header class="pattern-header single-header" style="text-shadow: 0 0 7px #000,0 0 7px #000">

      <h1 class="entry-title">
      数据结构100题 21~30题</h1>
      <p class="entry-census">
        <span>
          <a href="/">
            <img src="https://i.loli.net/2020/02/06/fuc7zI8iylU5ANt.jpg">
          </a>
        </span>
        <span>
          <a href="/">BoringHacker</a>
        </span>
        <span class="bull">
        ·</span>
        2020-2-8<span class="bull">
        ·</span>
      <span id="busuanzi_value_page_pv"></span>次阅读</p>
      
        
          <div>
            <ul class="spfk-ul">
              &nbsp<i class="fa fa-tag" aria-hidden="true"></i>&nbsp&nbsp&nbsp&nbsp
              <li class="spfk-li"><a href="/tags/DS100P/" class="butterfly-tags">DS100P</a></li>
            </ul>
          </div>
          <script>
              function colorInit(c,num){for(var i=1;i<=num;++i)c.push(i+'');}
              function paintTags(){
                  var colorNumber=8,tagColors=[],tags=document.getElementsByClassName('butterfly-tags');
                  for(var i = 0 ; i < tags.length ; ++i){
                      if(!tagColors.length)colorInit(tagColors,colorNumber);
                      var j=Math.floor(Math.random()*tagColors.length);
                      tags[i].classList.add("spfk-color"+tagColors[j]);
                      tagColors.splice(j,1);
                  }
              }
              paintTags()
          </script>
        
    </header>
  </div>

<div id="content" class="site-content">
  <div id="primary" class="content-area">
    <main id="main" class="site-main" role="main">
      <article id="post-1" class="post-1 post type-post status-publish format-standard has-post-thumbnail hentry category-uncategorized">
        <div class="toc"></div>
        <!--<div class="toc-entry-content"><!-- 套嵌目录使用（主要为了支援评论）-->
        
        <div class="entry-content">
          <h1 id="21-P4172-WC2006-水管局长"><a href="#21-P4172-WC2006-水管局长" class="headerlink" title="21.P4172 [WC2006]水管局长"></a>21.P4172 [WC2006]水管局长</h1><p>SC 省 MY 市有着庞大的地下水管网络，嘟嘟是 MY 市的水管局长（就是管水管的啦），嘟嘟作为水管局长的工作就是：每天供水公司可能要将一定量的水从 $x$ 处送往 $y$ 处，嘟嘟需要为供水公司找到一条从 $A$ 至 $B$ 的水管的路径，接着通过信息化的控制中心通知路径上的水管进入准备送水状态，等到路径上每一条水管都准备好了，供水公司就可以开始送水了。嘟嘟一次只能处理一项送水任务，等到当前的送水任务完成了，才能处理下一项。</p>
<p>在处理每项送水任务之前，路径上的水管都要进行一系列的准备操作，如清洗、消毒等等。嘟嘟在控制中心一声令下，这些水管的准备操作同时开始，但由于各条管道的长度、内径不同，进行准备操作需要的时间可能不同。供水公司总是希望嘟嘟能找到这样一条送水路径，路径上的所有管道全都准备就绪所需要的时间尽量短。嘟嘟希望你能帮助他完成这样的一个选择路径的系统，以满足供水公司的要求。另外，由于 MY 市的水管年代久远，一些水管会不时出现故障导致不能使用，你的程序必须考虑到这一点。</p>
<p>不妨将 MY 市的水管网络看作一幅简单无向图（即没有自环或重边）：水管是图中的边，水管的连接处为图中的结点。</p>
<hr>
<p>这道题只有删边操作，我们可以把这个过程看做是加边操作，这样好处理一点。</p>
<p>题目保证了图无论怎么删边都保证联通，所以我们可以先把图删完。删完后我们呢求出图的MST, 那么任意两点在这颗MST上走都是最优的<del>别问我怎么证贪心是用来证的吗</del>。我们可以用LCT来维护这颗MST，Splay维护区间最大值(也就是链上的最大值)</p>
<p>考虑加边操作。上面我提到了一个贪心：任意两点在这颗MST上走都是最优的。如果此时我们在MST上任意加一条边都会形成一个环。我们可以从任意一点入环，任意一点出环，方向随意。可以发现我们的最优解始终能避开最长的一条边！</p>
<p>考察这个环，用lct的split操作提出<code>链</code>的信息，查出最大的权值。发现我们可以通过删除权值最大的边来保证<code>环</code>上的最优。</p>
<p>怎么求出这条边呢？显然我们可以二分来找</p>
<p>再来考虑一个问题：如何维护边呢？</p>
<p>考虑用一个点来表示一条边。</p>
<p>最后<code>逆序</code>加边，把答案<code>逆序</code>输出即可</p>
<p>(<del>良心题解</del>)</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstdio&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;algorithm&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstring&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;queue&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stack&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> mid ((l + r) &gt;&gt; 1)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> mp make_pair</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> fir first</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> sec second</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> pub push_back</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> pob pop_back</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">long</span> <span class="keyword">long</span> LL;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> io_e <span class="meta-string">'\0'</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> io_s <span class="meta-string">' '</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> io_l <span class="meta-string">'\n'</span></span></span><br><span class="line"> <span class="meta">#<span class="meta-keyword">define</span> _DEBUG_ 1 <span class="comment">// debug toggle</span></span></span><br><span class="line"><span class="keyword">namespace</span> Fast_IO &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> _DEBUG_</span></span><br><span class="line">	<span class="meta">#<span class="meta-keyword">define</span> gc() (iS == iT ? (iT = (iS = ibuff) + fread(ibuff, 1, SIZ, stdin), (iS == iT ? EOF : *iS++)) : *iS++)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">	<span class="meta">#<span class="meta-keyword">define</span> gc() getchar()</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">int</span> SIZ = <span class="number">1</span> &lt;&lt; <span class="number">21</span> | <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">char</span> *iS, *iT, ibuff[SIZ], obuff[SIZ], *oS = obuff, *oT = oS + SIZ - <span class="number">1</span>, fu[<span class="number">110</span>], c;</span><br><span class="line">	<span class="keyword">int</span> fr;</span><br><span class="line">	<span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">ioout</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	    fwrite(obuff, <span class="number">1</span>, oS - obuff, <span class="built_in">stdout</span>);</span><br><span class="line">	    oS = obuff;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">template</span> &lt;<span class="class"><span class="keyword">class</span> <span class="title">Type</span>&gt;</span></span><br><span class="line"><span class="class">	<span class="title">inline</span> <span class="title">void</span> <span class="title">read</span>(<span class="title">Type</span>&amp; <span class="title">x</span>) &#123;</span></span><br><span class="line">	    x = <span class="number">0</span>;</span><br><span class="line">	    Type y = <span class="number">1</span>;</span><br><span class="line">	    <span class="keyword">for</span> (c = gc(); (c &gt; <span class="string">'9'</span> || c &lt; <span class="string">'0'</span>) &amp;&amp; c ^ <span class="string">'-'</span>; c = gc())</span><br><span class="line">	        ;</span><br><span class="line">	    c == <span class="string">'-'</span> ? y = <span class="number">-1</span> : x = (c &amp; <span class="number">15</span>);</span><br><span class="line">	    <span class="keyword">for</span> (c = gc(); c &gt;= <span class="string">'0'</span> &amp;&amp; c &lt;= <span class="string">'9'</span>; c = gc()) x = x * <span class="number">10</span> + (c &amp; <span class="number">15</span>);</span><br><span class="line">	    x *= y;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">inline</span> <span class="keyword">bool</span> <span class="title">blank</span><span class="params">(<span class="keyword">char</span> ch)</span> </span>&#123; <span class="keyword">return</span> ch == <span class="string">' '</span> || ch == <span class="string">'\n'</span> || ch == <span class="string">'\r'</span> || ch == <span class="string">'\t'</span>; &#125;</span><br><span class="line">	<span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">read</span><span class="params">(<span class="keyword">char</span>* s)</span> </span>&#123;</span><br><span class="line">	    <span class="keyword">register</span> <span class="keyword">char</span> ch = gc();</span><br><span class="line">	    <span class="keyword">for</span> (; blank(ch); ch = gc())</span><br><span class="line">	        ;</span><br><span class="line">	    <span class="keyword">for</span> (; !blank(ch); ch = gc()) *s++ = ch;</span><br><span class="line">	    *s = <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">read</span><span class="params">(<span class="keyword">char</span>&amp; c)</span> </span>&#123;</span><br><span class="line">	    <span class="keyword">for</span> (c = gc(); blank(c); c = gc())</span><br><span class="line">	        ;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">template</span> &lt;<span class="keyword">typename</span> Type, <span class="keyword">typename</span>... Args&gt;</span><br><span class="line">	<span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">read</span><span class="params">(Type&amp; t, Args&amp;... args)</span> </span>&#123;</span><br><span class="line">	    read(t), read(args...);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">template</span> &lt;<span class="keyword">typename</span>... Args&gt;</span><br><span class="line">	<span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">read</span><span class="params">(<span class="keyword">char</span>* t, Args&amp;... args)</span> </span>&#123;</span><br><span class="line">	    read(t), read(args...);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">template</span> &lt;<span class="keyword">typename</span>... Args&gt;</span><br><span class="line">	<span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">read</span><span class="params">(<span class="keyword">char</span>&amp; t, Args&amp;... args)</span> </span>&#123;</span><br><span class="line">	    read(t), read(args...);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">template</span> &lt;<span class="class"><span class="keyword">class</span> <span class="title">Type</span>&gt;</span></span><br><span class="line"><span class="class">	<span class="title">inline</span> <span class="title">void</span> <span class="title">write</span>(<span class="title">char</span> <span class="title">lastChar</span>, <span class="title">Type</span> <span class="title">x</span>) &#123;</span></span><br><span class="line">	    <span class="keyword">if</span> (x &lt; <span class="number">0</span>)</span><br><span class="line">	        *oS++ = <span class="string">'-'</span>, x = -x;</span><br><span class="line">	    <span class="keyword">if</span> (x == <span class="number">0</span>)</span><br><span class="line">	        *oS++ = <span class="string">'0'</span>;</span><br><span class="line">	    <span class="keyword">while</span> (x) fu[++fr] = x % <span class="number">10</span> + <span class="string">'0'</span>, x /= <span class="number">10</span>;</span><br><span class="line">	    <span class="keyword">while</span> (fr) *oS++ = fu[fr--];</span><br><span class="line">	    *oS++ = lastChar;</span><br><span class="line">	    ioout();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(<span class="keyword">char</span> lastChar, <span class="keyword">char</span> x[])</span> </span>&#123;</span><br><span class="line">	    <span class="keyword">for</span> (<span class="keyword">register</span> <span class="keyword">int</span> i = <span class="number">0</span>; x[i]; ++i) *oS++ = x[i];</span><br><span class="line">	    *oS++ = lastChar;</span><br><span class="line">	    ioout();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(<span class="keyword">char</span> lastChar, <span class="keyword">char</span> x)</span> </span>&#123;</span><br><span class="line">	    *oS++ = x;</span><br><span class="line">	    *oS++ = lastChar;</span><br><span class="line">	    ioout();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">template</span> &lt;<span class="keyword">typename</span> Type, <span class="keyword">typename</span>... Args&gt;</span><br><span class="line">	<span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(<span class="keyword">char</span> midChar, Type t, Args... args)</span> </span>&#123;</span><br><span class="line">	    write(midChar, t), write(midChar, args...);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;  <span class="comment">// namespace Fast_IO</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> Fast_IO::read;</span><br><span class="line"><span class="keyword">using</span> Fast_IO::write;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> LinkCutTree &#123;</span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">int</span> SIZE = <span class="number">12e4</span> + <span class="number">5</span>;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">SPLAY</span> &#123;</span></span><br><span class="line">		<span class="keyword">int</span> ch[<span class="number">2</span>];</span><br><span class="line">		<span class="keyword">int</span> fa;</span><br><span class="line">		<span class="keyword">int</span> key;</span><br><span class="line">		<span class="keyword">int</span> maxValue;</span><br><span class="line">		<span class="keyword">int</span> lazyTag;</span><br><span class="line">	&#125; T[SIZE];</span><br><span class="line">	<span class="built_in">stack</span> &lt; <span class="keyword">int</span> &gt; MemoryWaste; </span><br><span class="line">	<span class="meta">#<span class="meta-keyword">define</span> ls T[x].ch[0]</span></span><br><span class="line">	<span class="meta">#<span class="meta-keyword">define</span> rs T[x].ch[1]</span></span><br><span class="line">	<span class="meta">#<span class="meta-keyword">define</span> WhichSon(x) (T[T[x].fa].ch[1] == x)</span></span><br><span class="line">	<span class="meta">#<span class="meta-keyword">define</span> IsRoot(x) (T[T[x].fa].ch[0] ^ x &amp;&amp; T[T[x].fa].ch[1] ^ x)</span></span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">UpdateMessage</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</span><br><span class="line">		T[x].maxValue = max(max(T[ls].maxValue, T[x].key), T[rs].maxValue);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">UpdateSons</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (T[x].lazyTag) &#123;</span><br><span class="line">			ls ^= rs ^= ls ^= rs;</span><br><span class="line">			T[x].lazyTag = <span class="number">0</span>;</span><br><span class="line">			T[ls].lazyTag ^= <span class="number">1</span>;</span><br><span class="line">			T[rs].lazyTag ^= <span class="number">1</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">RotateNode</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">int</span> y = T[x].fa;</span><br><span class="line">		<span class="keyword">if</span> (!IsRoot(y)) T[T[y].fa].ch[WhichSon(y)] = x;</span><br><span class="line">		<span class="keyword">bool</span> k = WhichSon(x);</span><br><span class="line">		T[x].fa = T[y].fa;</span><br><span class="line">		T[y].fa = x;</span><br><span class="line">		T[y].ch[k] = T[x].ch[k ^ <span class="number">1</span>];</span><br><span class="line">		T[T[y].ch[k]].fa = y;</span><br><span class="line">		T[x].ch[k ^ <span class="number">1</span>] = y;</span><br><span class="line">		UpdateMessage(y);</span><br><span class="line">		UpdateMessage(x);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">LinkSplay</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">int</span> u = x;</span><br><span class="line">		<span class="keyword">while</span> (!IsRoot(u)) MemoryWaste.push(u), u = T[u].fa;</span><br><span class="line">		MemoryWaste.push(u);</span><br><span class="line">		<span class="keyword">while</span> (MemoryWaste.size()) UpdateSons(MemoryWaste.top()), MemoryWaste.pop();</span><br><span class="line">		<span class="keyword">for</span> (; !IsRoot(x); RotateNode(x)) &#123;</span><br><span class="line">			<span class="keyword">int</span> y = T[x].fa;</span><br><span class="line">			<span class="keyword">if</span> (!IsRoot(y))</span><br><span class="line">				RotateNode(WhichSon(x) ^ WhichSon(y) ? x : y);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">AccessEdge</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> u = x, y = <span class="number">0</span>; u; y = u, u = T[u].fa) &#123;</span><br><span class="line">			LinkSplay(u);</span><br><span class="line">			T[u].ch[<span class="number">1</span>] = y;</span><br><span class="line">			UpdateMessage(u);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">MakeRoot</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</span><br><span class="line">		AccessEdge(x);</span><br><span class="line">		LinkSplay(x);</span><br><span class="line">		T[x].lazyTag ^= <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">SplitTree</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y)</span> </span>&#123;</span><br><span class="line">		MakeRoot(x);</span><br><span class="line">		AccessEdge(y);</span><br><span class="line">		LinkSplay(y);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">LinkTree</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y)</span> </span>&#123;</span><br><span class="line">		MakeRoot(x);</span><br><span class="line">		T[x].fa = y;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">CutTree</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y)</span> </span>&#123;</span><br><span class="line">		MakeRoot(x);</span><br><span class="line">		AccessEdge(y);</span><br><span class="line">		LinkSplay(y);</span><br><span class="line">		T[x].fa = T[y].ch[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">int</span> <span class="title">FindByKey</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> u)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (T[x].key == u) <span class="keyword">return</span> x;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (T[ls].maxValue == u) <span class="keyword">return</span> FindByKey(ls, u);</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">return</span> FindByKey(rs, u);</span><br><span class="line">	&#125;</span><br><span class="line">&#125; <span class="comment">// namespace LinkCutTree</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> LinkCutTree;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> F[<span class="number">1005</span>][<span class="number">1005</span>], U[<span class="number">101000</span>], V[<span class="number">101000</span>];</span><br><span class="line"><span class="keyword">int</span> OP[<span class="number">101000</span>], ans[<span class="number">101000</span>], n, m, QueryNumber;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">EdgeNode</span> &#123;</span></span><br><span class="line">	<span class="keyword">int</span> x, y;</span><br><span class="line">	<span class="keyword">int</span> val, key;</span><br><span class="line">	EdgeNode() &#123; key = <span class="number">1</span>; &#125;</span><br><span class="line">	<span class="keyword">friend</span> <span class="keyword">bool</span> <span class="keyword">operator</span> &lt; (EdgeNode X, EdgeNode Y) &#123;</span><br><span class="line">		<span class="keyword">return</span> X.val &lt; Y.val;</span><br><span class="line">	&#125;</span><br><span class="line">&#125; e[<span class="number">101000</span>];</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">UnionFindSet</span> &#123;</span></span><br><span class="line">	<span class="keyword">int</span> fa[<span class="number">1010</span>];</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">int</span> <span class="title">find</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (x ^ fa[x]) fa[x] = find(fa[x]);</span><br><span class="line">		<span class="keyword">return</span> fa[x];</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">merge</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">int</span> u = find(x), v = find(y);</span><br><span class="line">		<span class="keyword">if</span> (u ^ v) fa[u] = v;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">(<span class="keyword">int</span> n, <span class="keyword">int</span> m)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; ++i)</span><br><span class="line">			fa[i] = i;</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= m; ++i) &#123;</span><br><span class="line">			<span class="keyword">if</span> (e[i].key &amp;&amp; find(e[i].x) ^ find(e[i].y)) &#123;</span><br><span class="line">				merge(e[i].x, e[i].y);</span><br><span class="line">				LinkTree(e[i].x, n + i);</span><br><span class="line">				LinkTree(e[i].y, n + i);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125; ufs;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">signed</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	read(n, m, QueryNumber);</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= m; ++i)</span><br><span class="line">		read(e[i].x, e[i].y, e[i].val);</span><br><span class="line">	sort(e + <span class="number">1</span>, e + <span class="number">1</span> + m);</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= m; ++i) &#123;</span><br><span class="line">		F[e[i].x][e[i].y] = i;</span><br><span class="line">		F[e[i].y][e[i].x] = i;</span><br><span class="line">		T[n + i].key = e[i].val;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= QueryNumber; ++i) &#123;</span><br><span class="line">		read(OP[i], U[i], V[i]);</span><br><span class="line">		<span class="keyword">if</span> (OP[i] == <span class="number">2</span>) e[F[U[i]][V[i]]].key = <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	ufs.init(n, m);</span><br><span class="line">	<span class="keyword">int</span> EdgeCount = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = QueryNumber; i &gt;= <span class="number">1</span>; --i) &#123;</span><br><span class="line">		SplitTree(U[i], V[i]);</span><br><span class="line">		<span class="keyword">if</span> (OP[i] == <span class="number">1</span>) ans[++EdgeCount] = T[V[i]].maxValue;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">int</span> Temporary = FindByKey(V[i], T[V[i]].maxValue);</span><br><span class="line">			<span class="keyword">if</span> (T[F[U[i]][V[i]] + n].key &lt; T[V[i]].maxValue) &#123;</span><br><span class="line">				CutTree(e[Temporary - n].x, Temporary);</span><br><span class="line">				CutTree(e[Temporary - n].y, Temporary);</span><br><span class="line">				LinkTree(U[i], F[U[i]][V[i]] + n);</span><br><span class="line">				LinkTree(V[i], F[U[i]][V[i]] + n);</span><br><span class="line">			&#125;	</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = EdgeCount; i &gt;= <span class="number">1</span>; --i)</span><br><span class="line">		write(io_l, ans[i]);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="22-P3302-SDOI2013-森林"><a href="#22-P3302-SDOI2013-森林" class="headerlink" title="22.P3302 [SDOI2013]森林"></a>22.P3302 [SDOI2013]森林</h1><p>小Z有一片森林，含有N个节点，每个节点上都有一个非负整数作为权值。初始的时候，森林中有M条边。</p>
<p>小Z希望执行T个操作，操作有两类：</p>
<ol>
<li><code>Q x y k</code>查询点x到点y路径上所有的权值中，第k小的权值是多少。此操作保证点x和点y连通，同时这两个节点的路径上至少有k个点。</li>
<li><code>L x y</code>在点x和点y之间连接一条边。保证完成此操作后，仍然是一片森林。</li>
</ol>
<p>为了体现程序的在线性，我们把输入数据进行了加密。设lastans为程序上一次输出的结果，初始的时候lastans为0。</p>
<ul>
<li>对于一个输入的操作<code>Q x y k</code>,其真实操作为<code>Q x^lastans y^lastans k^lastans</code>。</li>
<li>对于一个输入的操作<code>L x y</code>，其真实操作为<code>L x^lastans y^lastans</code>。其中^运算符表示异或，等价于pascal中的xor运算符。</li>
</ul>
<p>请写一个程序來帮助小Z完成这些操作。</p>
<hr>
<p>查询操作显然可以用主席树来完成，然而连接树的操作又让我们想到了lct。怎么办呢？<del>主席树+LCT？</del>(据说还真有人这么干)</p>
<p>启发式合并！</p>
<p>没错，我们用选择用主席树来完成这道题，合并时采用启发式合并。</p>
<p>具体来说就是每次合并时都用大小较小的树往大的合并，然后暴力遍历大小较小的树更新倍增数组和主席树即可</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> GCC diagnostic <span class="meta-keyword">error</span> <span class="meta-string">"-std=c++11"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstdio&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;algorithm&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstring&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;queue&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _size_ (tr[tr[x].l].size + tr[tr[y].l].size - tr[tr[lca].l].size - tr[tr[fa_lca].l].size)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> pii pair <span class="meta-string">&lt; int , int &gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> pll pair <span class="meta-string">&lt; LL, LL &gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> mid ((l + r) &gt;&gt; 1)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> mp make_pair</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> fir first</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> sec second</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> pub push_back</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> pob pop_back</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">long</span> <span class="keyword">long</span> LL;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> io_e <span class="meta-string">'\0'</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> io_s <span class="meta-string">' '</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> io_l <span class="meta-string">'\n'</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _DEBUG_ 1 <span class="comment">// debug toggle</span></span></span><br><span class="line"><span class="keyword">namespace</span> Fast_IO &#123;</span><br><span class="line">	<span class="meta">#<span class="meta-keyword">ifndef</span> _DEBUG_</span></span><br><span class="line">		<span class="meta">#<span class="meta-keyword">define</span> gc() (iS == iT ? (iT = (iS = ibuff) + fread(ibuff, 1, SIZ, stdin), (iS == iT ? EOF : *iS++)) : *iS++)</span></span><br><span class="line">	<span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">		<span class="meta">#<span class="meta-keyword">define</span> gc() getchar()</span></span><br><span class="line">	<span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">int</span> SIZ = <span class="number">1</span> &lt;&lt; <span class="number">21</span> | <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">char</span> *iS, *iT, ibuff[SIZ], obuff[SIZ], *oS = obuff, *oT = oS + SIZ - <span class="number">1</span>, fu[<span class="number">110</span>], c;</span><br><span class="line">	<span class="keyword">int</span> fr;</span><br><span class="line">	<span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">ioout</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	    fwrite(obuff, <span class="number">1</span>, oS - obuff, <span class="built_in">stdout</span>);</span><br><span class="line">	    oS = obuff;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">template</span> &lt;<span class="class"><span class="keyword">class</span> <span class="title">Type</span>&gt;</span></span><br><span class="line"><span class="class">	<span class="title">inline</span> <span class="title">void</span> <span class="title">read</span>(<span class="title">Type</span>&amp; <span class="title">x</span>) &#123;</span></span><br><span class="line">	    x = <span class="number">0</span>;</span><br><span class="line">	    Type y = <span class="number">1</span>;</span><br><span class="line">	    <span class="keyword">for</span> (c = gc(); (c &gt; <span class="string">'9'</span> || c &lt; <span class="string">'0'</span>) &amp;&amp; c ^ <span class="string">'-'</span>; c = gc())</span><br><span class="line">	        ;</span><br><span class="line">	    c == <span class="string">'-'</span> ? y = <span class="number">-1</span> : x = (c &amp; <span class="number">15</span>);</span><br><span class="line">	    <span class="keyword">for</span> (c = gc(); c &gt;= <span class="string">'0'</span> &amp;&amp; c &lt;= <span class="string">'9'</span>; c = gc()) x = x * <span class="number">10</span> + (c &amp; <span class="number">15</span>);</span><br><span class="line">	    x *= y;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">inline</span> <span class="keyword">bool</span> <span class="title">blank</span><span class="params">(<span class="keyword">char</span> ch)</span> </span>&#123; <span class="keyword">return</span> ch == <span class="string">' '</span> || ch == <span class="string">'\n'</span> || ch == <span class="string">'\r'</span> || ch == <span class="string">'\t'</span>; &#125;</span><br><span class="line">	<span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">read</span><span class="params">(<span class="keyword">char</span>* s)</span> </span>&#123;</span><br><span class="line">	    <span class="keyword">register</span> <span class="keyword">char</span> ch = gc();</span><br><span class="line">	    <span class="keyword">for</span> (; blank(ch); ch = gc())</span><br><span class="line">	        ;</span><br><span class="line">	    <span class="keyword">for</span> (; !blank(ch); ch = gc()) *s++ = ch;</span><br><span class="line">	    *s = <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">read</span><span class="params">(<span class="keyword">char</span>&amp; c)</span> </span>&#123;</span><br><span class="line">	    <span class="keyword">for</span> (c = gc(); blank(c); c = gc())</span><br><span class="line">	        ;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">template</span> &lt;<span class="keyword">typename</span> Type, <span class="keyword">typename</span>... Args&gt;</span><br><span class="line">	<span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">read</span><span class="params">(Type&amp; t, Args&amp;... args)</span> </span>&#123;</span><br><span class="line">	    read(t), read(args...);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">template</span> &lt;<span class="keyword">typename</span>... Args&gt;</span><br><span class="line">	<span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">read</span><span class="params">(<span class="keyword">char</span>* t, Args&amp;... args)</span> </span>&#123;</span><br><span class="line">	    read(t), read(args...);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">template</span> &lt;<span class="keyword">typename</span>... Args&gt;</span><br><span class="line">	<span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">read</span><span class="params">(<span class="keyword">char</span>&amp; t, Args&amp;... args)</span> </span>&#123;</span><br><span class="line">	    read(t), read(args...);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">template</span> &lt;<span class="class"><span class="keyword">class</span> <span class="title">Type</span>&gt;</span></span><br><span class="line"><span class="class">	<span class="title">inline</span> <span class="title">void</span> <span class="title">write</span>(<span class="title">char</span> <span class="title">lastChar</span>, <span class="title">Type</span> <span class="title">x</span>) &#123;</span></span><br><span class="line">	    <span class="keyword">if</span> (x &lt; <span class="number">0</span>)</span><br><span class="line">	        *oS++ = <span class="string">'-'</span>, x = -x;</span><br><span class="line">	    <span class="keyword">if</span> (x == <span class="number">0</span>)</span><br><span class="line">	        *oS++ = <span class="string">'0'</span>;</span><br><span class="line">	    <span class="keyword">while</span> (x) fu[++fr] = x % <span class="number">10</span> + <span class="string">'0'</span>, x /= <span class="number">10</span>;</span><br><span class="line">	    <span class="keyword">while</span> (fr) *oS++ = fu[fr--];</span><br><span class="line">	    *oS++ = lastChar;</span><br><span class="line">	    ioout();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(<span class="keyword">char</span> lastChar, <span class="keyword">char</span> x[])</span> </span>&#123;</span><br><span class="line">	    <span class="keyword">for</span> (<span class="keyword">register</span> <span class="keyword">int</span> i = <span class="number">0</span>; x[i]; ++i) *oS++ = x[i];</span><br><span class="line">	    *oS++ = lastChar;</span><br><span class="line">	    ioout();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(<span class="keyword">char</span> lastChar, <span class="keyword">char</span> x)</span> </span>&#123;</span><br><span class="line">	    *oS++ = x;</span><br><span class="line">	    *oS++ = lastChar;</span><br><span class="line">	    ioout();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">template</span> &lt;<span class="keyword">typename</span> Type, <span class="keyword">typename</span>... Args&gt;</span><br><span class="line">	<span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(<span class="keyword">char</span> midChar, Type t, Args... args)</span> </span>&#123;</span><br><span class="line">	    write(midChar, t), write(midChar, args...);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;  <span class="comment">// namespace Fast_IO</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> Fast_IO::read;</span><br><span class="line"><span class="keyword">using</span> Fast_IO::write;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> SIZE = <span class="number">9e4</span> + <span class="number">5</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> LSIZE = SIZE &lt;&lt; <span class="number">7</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> GSIZE = SIZE &lt;&lt; <span class="number">1</span>;</span><br><span class="line"><span class="keyword">int</span> n, m, q, waste;</span><br><span class="line"><span class="keyword">int</span> tot, rt[LSIZE], b[SIZE];</span><br><span class="line"><span class="keyword">int</span> pri_n, edge_tot, a[SIZE];</span><br><span class="line"><span class="keyword">int</span> Head[GSIZE], Next[GSIZE];</span><br><span class="line"><span class="keyword">int</span> Vertex[GSIZE], Weight[GSIZE];</span><br><span class="line"><span class="keyword">int</span> f[SIZE][LSIZE / SIZE &gt;&gt; <span class="number">2</span>];</span><br><span class="line"><span class="keyword">int</span> dp[SIZE], fa[SIZE], id[SIZE];</span><br><span class="line"><span class="keyword">int</span> size[SIZE], vis[SIZE];</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">TreeNode</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> l, r;</span><br><span class="line">    <span class="keyword">int</span> size;</span><br><span class="line">&#125; tr[LSIZE];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">add</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y, <span class="keyword">int</span> z = <span class="number">1</span>)</span> </span>&#123;</span><br><span class="line">    Vertex[++edge_tot] = y, Weight[edge_tot] = z;</span><br><span class="line">    Next[edge_tot] = Head[x], Head[x] = edge_tot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">find_set</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> x == fa[x] ? x : fa[x] = find_set(fa[x]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">make</span><span class="params">(<span class="keyword">int</span> l, <span class="keyword">int</span> r)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> u = ++tot;</span><br><span class="line">    <span class="keyword">if</span> (l ^ r) <span class="keyword">return</span> tr[u].l = make(l, mid), tr[u].r = make(mid + <span class="number">1</span>, r), u;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">modify</span><span class="params">(<span class="keyword">int</span> &amp;u, <span class="keyword">int</span> pre, <span class="keyword">int</span> l, <span class="keyword">int</span> r, <span class="keyword">int</span> x)</span> </span>&#123;</span><br><span class="line">    u = ++tot;</span><br><span class="line">    tr[u] = TreeNode&#123;tr[pre].l, tr[pre].r, tr[pre].size + <span class="number">1</span>&#125;;</span><br><span class="line">	<span class="keyword">if</span> (l ^ r)</span><br><span class="line">		<span class="keyword">if</span> (mid &gt;= x) modify(tr[u].l, tr[pre].l, l, mid, x);</span><br><span class="line">		<span class="keyword">else</span> modify(tr[u].r, tr[pre].r, mid + <span class="number">1</span>, r, x);</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">return</span> ;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">query</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y, <span class="keyword">int</span> lca, <span class="keyword">int</span> fa_lca, <span class="keyword">int</span> l, <span class="keyword">int</span> r, <span class="keyword">int</span> k)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (l ^ r)</span><br><span class="line">		<span class="keyword">if</span> (_size_ &gt;= k) <span class="keyword">return</span> query(tr[x].l, tr[y].l, tr[lca].l, tr[fa_lca].l, l, mid, k);</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">return</span> query(tr[x].r, tr[y].r, tr[lca].r, tr[fa_lca].r, mid + <span class="number">1</span>, r, k - _size_);</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">return</span> l;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">dfs</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> _rt_)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; <span class="number">17</span>; ++i) f[x][i] = f[f[x][i - <span class="number">1</span>]][i - <span class="number">1</span>];</span><br><span class="line">	modify(rt[x], rt[f[x][<span class="number">0</span>]], <span class="number">1</span>, pri_n, id[x]);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> y Vertex[i]</span></span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = Head[x]; i; i = Next[i]) <span class="keyword">if</span> (y ^ fa[x]) f[y][<span class="number">0</span>] = x, fa[y] = x, dp[y] = dp[x] + <span class="number">1</span>, vis[x] = <span class="literal">true</span>, size[_rt_]++, dfs(y, _rt_);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">undef</span> y</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">get_lca</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (dp[x] &lt; dp[y]) x ^= y ^= x ^= y;</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">16</span>; i &gt;= <span class="number">0</span>; --i) <span class="keyword">if</span> (f[x][i] &amp;&amp; dp[f[x][i]] &gt;= dp[y]) x = f[x][i];</span><br><span class="line">	<span class="keyword">if</span> (x == y) <span class="keyword">return</span> x;</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">16</span>; i &gt;= <span class="number">0</span>; --i) <span class="keyword">if</span> (f[x][i] ^ f[y][i]) x = f[x][i], y = f[y][i];</span><br><span class="line">	<span class="keyword">return</span> f[x][<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">signed</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	read(waste, n, m, q);</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; ++i) read(a[i]), b[i] = a[i];</span><br><span class="line">	sort(b + <span class="number">1</span>, b + <span class="number">1</span> + n);</span><br><span class="line">	pri_n = unique(b + <span class="number">1</span>, b + <span class="number">1</span> + n) - b - <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; ++i) id[i] = lower_bound(b + <span class="number">1</span>, b + <span class="number">1</span> + pri_n, a[i]) - b;</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>, x, y; i &lt;= m; ++i) read(x, y), add(x, y, <span class="number">1</span>), add(y, x, <span class="number">1</span>);</span><br><span class="line">	*rt = make(<span class="number">1</span>, pri_n);</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; ++i) <span class="keyword">if</span> (!vis[i]) dfs(i, i), fa[i] = i;</span><br><span class="line">	<span class="keyword">int</span> ans = <span class="number">0</span>, lastans = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> enum_q = <span class="number">0</span>; enum_q &lt; q; ++enum_q) &#123;</span><br><span class="line">		<span class="keyword">char</span> opt[<span class="number">5</span>];</span><br><span class="line">		<span class="keyword">int</span> x, y, k, lca;</span><br><span class="line">		read(opt), read(x, y);</span><br><span class="line">		x ^= lastans, y ^= lastans;</span><br><span class="line">		<span class="keyword">if</span> (*opt == <span class="string">'Q'</span>) read(k), k ^= lastans, lca = get_lca(x, y), write(io_l, lastans = ans = b[query(rt[x], rt[y], rt[lca], rt[f[lca][<span class="number">0</span>]], <span class="number">1</span>, pri_n, k)]);</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			add(x, y, <span class="number">1</span>);</span><br><span class="line">			add(y, x, <span class="number">1</span>);</span><br><span class="line">			<span class="keyword">int</span> u = find_set(x);</span><br><span class="line">			<span class="keyword">int</span> v = find_set(y);</span><br><span class="line">			<span class="keyword">if</span> (size[u] &lt; size[v]) x ^= y ^= x ^= y, u ^= v ^= u ^= v;</span><br><span class="line">			f[y][<span class="number">0</span>] = x;</span><br><span class="line">			fa[y] = x;</span><br><span class="line">			dp[y] = dp[x] + <span class="number">1</span>;</span><br><span class="line">			vis[y] = <span class="literal">true</span>;</span><br><span class="line">			size[u]++;</span><br><span class="line">			dfs(y, v);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="23-P3250-HNOI2016-网络"><a href="#23-P3250-HNOI2016-网络" class="headerlink" title="23.P3250 [HNOI2016]网络"></a>23.P3250 [HNOI2016]网络</h1><p>一个简单的网络系统可以被描述成一棵无根树。每个节点为一个服务器。连接服务器与服务器的数据线则看做一条树边。两个服务器进行数据的交互时，数据会经过连接这两个服务器的路径上的所有服务器（包括这两个服务器自身）。</p>
<p>由于这条路径是唯一的，当路径上的某个服务器出现故障，无法正常运行时，数据便无法交互。此外，每个数据交互请求都有一个重要度，越重要的请求显然需要得到越高的优先处理权。现在，你作为一个网络系统的管理员，要监控整个系统的运行状态。系统的运行也是很简单的，在每一个时刻，只有可能出现下列三种事件中的一种：</p>
<ol>
<li><p>在某两个服务器之间出现一条新的数据交互请求；</p>
</li>
<li><p>某个数据交互结束请求；</p>
</li>
<li><p>某个服务器出现故障。系统会在任何故障发生后立即修复。也就是在出现故障的时刻之后，这个服务器依然是正常的。但在服务器产生故障时依然会对需要经过该服务器的数据交互请求造成影响。</p>
</li>
</ol>
<p>你的任务是在每次出现故障时，维护未被影响的请求中重要度的最大值。注意，如果一个数据交互请求已经结束，则不将其纳入未被影响的请求范围。</p>
<hr>
<p>提供 $\Theta(n\log^3n)$ 的暴力树剖打法。</p>
<p>本来我想搞树套树+树剖的，但发现Splay常数过大容易T爆，fhq-treap也炸了。</p>
<p>后来我幡然醒悟我们只需要开两个优先队列一个放添加的值，一个放删除的值。</p>
<p>碰到查询操作时先比较两个堆的堆顶，如果相同显然它被删掉了，两个栈同时弹出；不相同时添加元素队列的队首就是答案。</p>
<p>而且这道题开O2效果特别明显，2.x s 能变成 xxx ms!</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> GCC diagnostic <span class="meta-keyword">error</span> <span class="meta-string">"-std=c++11"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstdio&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;algorithm&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstring&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;queue&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CheckSize ((d[top[x]] &lt; d[top[y]]) &amp;&amp; (x ^= y ^= x ^= y))</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ForGraph int i = Head[x], y = Vertex[i]; i; i = Next[i], y = Vertex[i]</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> pii pair <span class="meta-string">&lt; int , int &gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> pll pair <span class="meta-string">&lt; LL, LL &gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> mid ((l + r) &gt;&gt; 1)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> mp make_pair</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> fir first</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> sec second</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> pub push_back</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> pob pop_back</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">long</span> <span class="keyword">long</span> LL;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> io_e <span class="meta-string">'\0'</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> io_s <span class="meta-string">' '</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> io_l <span class="meta-string">'\n'</span></span></span><br><span class="line"><span class="comment">// #define _DEBUG_ 1 // debug toggle</span></span><br><span class="line"><span class="keyword">namespace</span> Fast_IO &#123;</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">ifndef</span> _DEBUG_</span></span><br><span class="line">        <span class="meta">#<span class="meta-keyword">define</span> gc() (iS == iT ? (iT = (iS = ibuff) + fread(ibuff, 1, SIZ, stdin), (iS == iT ? EOF : *iS++)) : *iS++)</span></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">        <span class="meta">#<span class="meta-keyword">define</span> gc() getchar()</span></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">int</span> SIZ = <span class="number">1</span> &lt;&lt; <span class="number">21</span> | <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">char</span> *iS, *iT, ibuff[SIZ], obuff[SIZ], *oS = obuff, *oT = oS + SIZ - <span class="number">1</span>, fu[<span class="number">110</span>], c;</span><br><span class="line">    <span class="keyword">int</span> fr;</span><br><span class="line">    <span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">ioout</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        fwrite(obuff, <span class="number">1</span>, oS - obuff, <span class="built_in">stdout</span>);</span><br><span class="line">        oS = obuff;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="class"><span class="keyword">class</span> <span class="title">Type</span>&gt;</span></span><br><span class="line"><span class="class">    <span class="title">inline</span> <span class="title">void</span> <span class="title">read</span>(<span class="title">Type</span>&amp; <span class="title">x</span>) &#123;</span></span><br><span class="line">        x = <span class="number">0</span>;</span><br><span class="line">        Type y = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">for</span> (c = gc(); (c &gt; <span class="string">'9'</span> || c &lt; <span class="string">'0'</span>) &amp;&amp; c ^ <span class="string">'-'</span>; c = gc())</span><br><span class="line">            ;</span><br><span class="line">        c == <span class="string">'-'</span> ? y = <span class="number">-1</span> : x = (c &amp; <span class="number">15</span>);</span><br><span class="line">        <span class="keyword">for</span> (c = gc(); c &gt;= <span class="string">'0'</span> &amp;&amp; c &lt;= <span class="string">'9'</span>; c = gc()) x = x * <span class="number">10</span> + (c &amp; <span class="number">15</span>);</span><br><span class="line">        x *= y;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">inline</span> <span class="keyword">bool</span> <span class="title">blank</span><span class="params">(<span class="keyword">char</span> ch)</span> </span>&#123; <span class="keyword">return</span> ch == <span class="string">' '</span> || ch == <span class="string">'\n'</span> || ch == <span class="string">'\r'</span> || ch == <span class="string">'\t'</span>; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">read</span><span class="params">(<span class="keyword">char</span>* s)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">register</span> <span class="keyword">char</span> ch = gc();</span><br><span class="line">        <span class="keyword">for</span> (; blank(ch); ch = gc())</span><br><span class="line">            ;</span><br><span class="line">        <span class="keyword">for</span> (; !blank(ch); ch = gc()) *s++ = ch;</span><br><span class="line">        *s = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">read</span><span class="params">(<span class="keyword">char</span>&amp; c)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (c = gc(); blank(c); c = gc())</span><br><span class="line">            ;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">typename</span> Type, <span class="keyword">typename</span>... Args&gt;</span><br><span class="line">    <span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">read</span><span class="params">(Type&amp; t, Args&amp;... args)</span> </span>&#123;</span><br><span class="line">        read(t), read(args...);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">typename</span>... Args&gt;</span><br><span class="line">    <span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">read</span><span class="params">(<span class="keyword">char</span>* t, Args&amp;... args)</span> </span>&#123;</span><br><span class="line">        read(t), read(args...);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">typename</span>... Args&gt;</span><br><span class="line">    <span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">read</span><span class="params">(<span class="keyword">char</span>&amp; t, Args&amp;... args)</span> </span>&#123;</span><br><span class="line">        read(t), read(args...);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="class"><span class="keyword">class</span> <span class="title">Type</span>&gt;</span></span><br><span class="line"><span class="class">    <span class="title">inline</span> <span class="title">void</span> <span class="title">write</span>(<span class="title">char</span> <span class="title">lastChar</span>, <span class="title">Type</span> <span class="title">x</span>) &#123;</span></span><br><span class="line">        <span class="keyword">if</span> (x &lt; <span class="number">0</span>)</span><br><span class="line">            *oS++ = <span class="string">'-'</span>, x = -x;</span><br><span class="line">        <span class="keyword">if</span> (x == <span class="number">0</span>)</span><br><span class="line">            *oS++ = <span class="string">'0'</span>;</span><br><span class="line">        <span class="keyword">while</span> (x) fu[++fr] = x % <span class="number">10</span> + <span class="string">'0'</span>, x /= <span class="number">10</span>;</span><br><span class="line">        <span class="keyword">while</span> (fr) *oS++ = fu[fr--];</span><br><span class="line">        *oS++ = lastChar;</span><br><span class="line">        ioout();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(<span class="keyword">char</span> lastChar, <span class="keyword">char</span> x[])</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">register</span> <span class="keyword">int</span> i = <span class="number">0</span>; x[i]; ++i) *oS++ = x[i];</span><br><span class="line">        *oS++ = lastChar;</span><br><span class="line">        ioout();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(<span class="keyword">char</span> lastChar, <span class="keyword">char</span> x)</span> </span>&#123;</span><br><span class="line">        *oS++ = x;</span><br><span class="line">        *oS++ = lastChar;</span><br><span class="line">        ioout();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">typename</span> Type, <span class="keyword">typename</span>... Args&gt;</span><br><span class="line">    <span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(<span class="keyword">char</span> midChar, Type t, Args... args)</span> </span>&#123;</span><br><span class="line">        write(midChar, t), write(midChar, args...);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;  <span class="comment">// namespace Fast_IO</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> Fast_IO::read;</span><br><span class="line"><span class="keyword">using</span> Fast_IO::write;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> HNOI2016_Network &#123;</span><br><span class="line">	<span class="keyword">namespace</span> IamJustForPlaying &#123;</span><br><span class="line">	<span class="keyword">namespace</span> IamJustForPlaying &#123;</span><br><span class="line">	<span class="keyword">namespace</span> IamJustForPlaying &#123;</span><br><span class="line">	<span class="keyword">namespace</span> IamJustForPlaying &#123;</span><br><span class="line">	<span class="keyword">namespace</span> IamJustForPlaying &#123;</span><br><span class="line">	<span class="keyword">namespace</span> IamJustForPlaying &#123;</span><br><span class="line">	<span class="keyword">namespace</span> IamJustForPlaying &#123;</span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">int</span> SIZE = <span class="number">2e5</span> + <span class="number">5</span>;</span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">int</span> GSIZE = SIZE &lt;&lt; <span class="number">1</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">namespace</span> SegmentTree &#123;</span><br><span class="line">		priority_queue &lt; <span class="keyword">int</span> &gt; I[SIZE&lt;&lt;<span class="number">1</span>], D[SIZE&lt;&lt;<span class="number">1</span>];</span><br><span class="line">		<span class="meta">#<span class="meta-keyword">define</span> ls (k &lt;&lt; 1)</span></span><br><span class="line">		<span class="meta">#<span class="meta-keyword">define</span> rs (k &lt;&lt; 1 | 1)</span></span><br><span class="line">		</span><br><span class="line">		<span class="function"><span class="keyword">void</span> <span class="title">DoModify</span><span class="params">(<span class="keyword">int</span> k, <span class="keyword">int</span> l, <span class="keyword">int</span> r, <span class="keyword">int</span> x, <span class="keyword">int</span> y, <span class="keyword">int</span> val, <span class="keyword">int</span> opt)</span> </span>&#123;</span><br><span class="line">			<span class="keyword">if</span> (!(l &gt; y || r &lt; x))</span><br><span class="line">				<span class="keyword">if</span> (l &gt;= x &amp;&amp; r &lt;= y)</span><br><span class="line">					<span class="keyword">if</span> (opt) I[k].push(val);</span><br><span class="line">					<span class="keyword">else</span> D[k].push(val);</span><br><span class="line">				<span class="keyword">else</span> DoModify(ls, l, mid, x, y, val, opt), DoModify(rs, mid + <span class="number">1</span>, r, x, y, val, opt);</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="function"><span class="keyword">int</span> <span class="title">GetAnswer</span><span class="params">(<span class="keyword">int</span> k, <span class="keyword">int</span> l, <span class="keyword">int</span> r, <span class="keyword">int</span> x)</span> </span>&#123;</span><br><span class="line">			<span class="keyword">while</span> (I[k].size() &amp;&amp; D[k].size() &amp;&amp; I[k].top() == D[k].top()) I[k].pop(), D[k].pop();</span><br><span class="line">			<span class="keyword">int</span> res = I[k].size() ? I[k].top() : <span class="number">-1</span>;</span><br><span class="line">			<span class="keyword">if</span> (l ^ r)</span><br><span class="line">				<span class="keyword">if</span> (mid &gt;= x) res = max(res, GetAnswer(ls, l, mid, x));</span><br><span class="line">				<span class="keyword">else</span> res = max(res, GetAnswer(rs, mid + <span class="number">1</span>, r, x));</span><br><span class="line">			<span class="keyword">return</span> res;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; <span class="comment">// namespace SegmentTree</span></span><br><span class="line">	</span><br><span class="line">	<span class="keyword">namespace</span> TreeChainSplitting &#123;</span><br><span class="line">		<span class="keyword">int</span> tx[SIZE], ty[SIZE], tk[SIZE];</span><br><span class="line">		<span class="keyword">int</span> Head[SIZE], Vertex[GSIZE];</span><br><span class="line">		<span class="keyword">int</span> Next[GSIZE], EdgeCount;</span><br><span class="line">		<span class="keyword">int</span> fa[SIZE], size[SIZE];</span><br><span class="line">		<span class="keyword">int</span> d[SIZE], son[SIZE];</span><br><span class="line">		<span class="keyword">int</span> dfn[SIZE], rnk[SIZE];</span><br><span class="line">		<span class="keyword">int</span> top[SIZE], tot;</span><br><span class="line">		<span class="keyword">int</span> edge_tot = <span class="number">0</span>, n, m;</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">Vector2</span> &#123;</span></span><br><span class="line">			<span class="keyword">int</span> x; <span class="keyword">int</span> y;</span><br><span class="line">			</span><br><span class="line">			<span class="keyword">friend</span> <span class="keyword">bool</span> <span class="keyword">operator</span> &lt; (Vector2 rhs1, Vector2 rhs2) &#123; <span class="keyword">return</span> rhs1.x &lt; rhs2.x; &#125;</span><br><span class="line">		&#125; Vec2[SIZE];</span><br><span class="line">		</span><br><span class="line">		<span class="function"><span class="keyword">void</span> <span class="title">add</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y)</span> </span>&#123;</span><br><span class="line">			Vertex[++edge_tot] = y;</span><br><span class="line">			Next[edge_tot] = Head[x];</span><br><span class="line">			Head[x] = edge_tot;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="function"><span class="keyword">void</span> <span class="title">dfs1</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> fa)</span> </span>&#123;</span><br><span class="line">			size[x] = <span class="number">1</span>, TreeChainSplitting::fa[x] = fa, d[x] = d[fa] + <span class="number">1</span>;</span><br><span class="line">			<span class="keyword">for</span> (ForGraph) <span class="keyword">if</span> (y ^ fa) dfs1(y, x), size[x] += size[y], ((size[son[x]] &lt; size[y]) &amp;&amp; (son[x] = y));</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="function"><span class="keyword">void</span> <span class="title">dfs2</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> tp)</span> </span>&#123;</span><br><span class="line">			top[x] = tp, dfn[x] = ++tot, rnk[tot] = x;</span><br><span class="line">			<span class="keyword">if</span> (son[x]) dfs2(son[x], tp);</span><br><span class="line">			<span class="keyword">for</span> (ForGraph) <span class="keyword">if</span> (y ^ fa[x] &amp;&amp; y ^ son[x]) dfs2(y, y);</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="function"><span class="keyword">void</span> <span class="title">ModifySubTree</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y, <span class="keyword">int</span> val, <span class="keyword">int</span> opt, <span class="keyword">int</span> tp = <span class="number">0</span>)</span> </span>&#123;</span><br><span class="line">			<span class="keyword">while</span> (top[x] ^ top[y]) CheckSize, Vec2[++tp] = &#123;dfn[top[x]], dfn[x]&#125;, x = fa[top[x]];</span><br><span class="line">			<span class="keyword">if</span> (dfn[x] &gt; dfn[y]) x ^= y ^= x ^= y;</span><br><span class="line">			Vec2[++tp] = &#123;dfn[x], dfn[y]&#125;;</span><br><span class="line">			sort(Vec2 + <span class="number">1</span>, Vec2 + <span class="number">1</span> + tp);</span><br><span class="line">			<span class="keyword">int</span> Sys = <span class="number">1</span>;</span><br><span class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= tp; ++i) ((Sys &lt; Vec2[i].x) &amp;&amp; (SegmentTree::DoModify(<span class="number">1</span>, <span class="number">1</span>, n, Sys, Vec2[i].x - <span class="number">1</span>, val, opt), <span class="number">1</span>)), Sys = Vec2[i].y + <span class="number">1</span>;</span><br><span class="line">			<span class="keyword">if</span> (Sys &lt;= n) SegmentTree::DoModify(<span class="number">1</span>, <span class="number">1</span>, n, Sys, n, val, opt);</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">			read(n, m);</span><br><span class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>, x, y; i &lt; n; ++i) read(x, y), add(x, y), add(y, x);</span><br><span class="line">			dfs1(<span class="number">1</span>, <span class="number">0</span>), dfs2(<span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>, x, y, k, t, opt; i &lt;= m; ++i) &#123;</span><br><span class="line">				read(opt);</span><br><span class="line">				<span class="keyword">if</span> (opt == <span class="number">0</span>) read(x, y, k), ModifySubTree(x, y, k, <span class="number">1</span>), tx[i] = x, ty[i] = y, tk[i] = k;</span><br><span class="line">				<span class="keyword">else</span> <span class="keyword">if</span> (opt == <span class="number">1</span>) read(t), ModifySubTree(tx[t], ty[t], tk[t], <span class="number">0</span>);</span><br><span class="line">				<span class="keyword">else</span> <span class="keyword">if</span> (opt == <span class="number">2</span>) read(x), write(io_l, SegmentTree::GetAnswer(<span class="number">1</span>, <span class="number">1</span>, n, dfn[x]));</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; <span class="comment">// namespace TreeChainSplittin</span></span><br><span class="line">	&#125; <span class="comment">// namespace IamJustForPlaying</span></span><br><span class="line">	&#125; <span class="comment">// namespace IamJustForPlaying</span></span><br><span class="line">	&#125; <span class="comment">// namespace IamJustForPlaying</span></span><br><span class="line">	&#125; <span class="comment">// namespace IamJustForPlaying</span></span><br><span class="line">	&#125; <span class="comment">// namespace IamJustForPlaying</span></span><br><span class="line">	&#125; <span class="comment">// namespace IamJustForPlaying</span></span><br><span class="line">	&#125; <span class="comment">// namespace IamJustForPlaying</span></span><br><span class="line">&#125; <span class="comment">// namespace HNOI2016_Network</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">signed</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	HNOI2016_Network::IamJustForPlaying::IamJustForPlaying::IamJustForPlaying::IamJustForPlaying::IamJustForPlaying::IamJustForPlaying::IamJustForPlaying::TreeChainSplitting::main();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="24-P4211-LNOI2014-LCA"><a href="#24-P4211-LNOI2014-LCA" class="headerlink" title="24.P4211 [LNOI2014]LCA"></a>24.P4211 [LNOI2014]LCA</h1><p>给出一个n个节点的有根树（编号为0到n-1，根节点为0）。一个点的深度定义为这个节点到根的距离+1。<br>设dep[i]表示点i的深度，LCA(i,j)表示i与j的最近公共祖先。<br>有q次询问，每次询问给出l r z，求$\sum_{l \leq i \leq r}dep[LCA(i,z)]$</p>
<hr>
<p>问题可以转化为求点到根的距离+1，询问l到r的结点到根的距离和。</p>
<p>这相当于是在求结点到根的点权+1的和。</p>
<p>那么该怎么办呢？</p>
<p>显然我们可以离线得到所有的询问，然后将差分询问，也就是查询 $[1,r]-[1,l-1]$</p>
<p>我们可以在l-1和r处打标记，然后遍历树的结点有标记就执行查询操作。</p>
<p>方便起见我们可以用树链剖分来维护，时间复杂度n乘上一个Log方n。</p>
<p>(对了我的代码特别玄学，查询部分循环版本在luogu上T了，在lojA了，递归版本在luoguA了，在lojT了！)</p>
<p>(我对这份代码除了缓缓地打出一个问号也不能说什么了)</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> GCC diagnostic <span class="meta-keyword">error</span> <span class="meta-string">"-std=c++11"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstdio&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;algorithm&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstring&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;queue&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IT vector <span class="meta-string">&lt; int &gt;::iterator</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ForGraph int i = Head[x], y = Vert[i]; i; i = Next[i], y = Vert[i]</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CheckSize ((size[son[x]] &lt; size[y]) &amp;&amp; (son[x] = y))</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TCS TreeChainSplitting</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CFS ChainForwardStar</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PS ProblemSolver</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> pii pair <span class="meta-string">&lt; int , int &gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> pll pair <span class="meta-string">&lt; LL, LL &gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> mid ((l + r) &gt;&gt; 1)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> mp make_pair</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> fir first</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> sec second</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> pub push_back</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> pob pop_back</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">long</span> <span class="keyword">long</span> LL;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> io_e <span class="meta-string">'\0'</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> io_s <span class="meta-string">' '</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> io_l <span class="meta-string">'\n'</span></span></span><br><span class="line"> <span class="meta">#<span class="meta-keyword">define</span> _DEBUG_ 1 <span class="comment">// debug toggle</span></span></span><br><span class="line"><span class="keyword">namespace</span> Fast_IO &#123;</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">ifndef</span> _DEBUG_</span></span><br><span class="line">        <span class="meta">#<span class="meta-keyword">define</span> gc() (iS == iT ? (iT = (iS = ibuff) + fread(ibuff, 1, SIZ, stdin), (iS == iT ? EOF : *iS++)) : *iS++)</span></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">        <span class="meta">#<span class="meta-keyword">define</span> gc() getchar()</span></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">int</span> SIZ = <span class="number">1</span> &lt;&lt; <span class="number">21</span> | <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">char</span> *iS, *iT, ibuff[SIZ], obuff[SIZ], *oS = obuff, *oT = oS + SIZ - <span class="number">1</span>, fu[<span class="number">110</span>], c;</span><br><span class="line">    <span class="keyword">int</span> fr;</span><br><span class="line">    <span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">ioout</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        fwrite(obuff, <span class="number">1</span>, oS - obuff, <span class="built_in">stdout</span>);</span><br><span class="line">        oS = obuff;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="class"><span class="keyword">class</span> <span class="title">Type</span>&gt;</span></span><br><span class="line"><span class="class">    <span class="title">inline</span> <span class="title">void</span> <span class="title">read</span>(<span class="title">Type</span>&amp; <span class="title">x</span>) &#123;</span></span><br><span class="line">        x = <span class="number">0</span>;</span><br><span class="line">        Type y = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">for</span> (c = gc(); (c &gt; <span class="string">'9'</span> || c &lt; <span class="string">'0'</span>) &amp;&amp; c ^ <span class="string">'-'</span>; c = gc())</span><br><span class="line">            ;</span><br><span class="line">        c == <span class="string">'-'</span> ? y = <span class="number">-1</span> : x = (c &amp; <span class="number">15</span>);</span><br><span class="line">        <span class="keyword">for</span> (c = gc(); c &gt;= <span class="string">'0'</span> &amp;&amp; c &lt;= <span class="string">'9'</span>; c = gc()) x = x * <span class="number">10</span> + (c &amp; <span class="number">15</span>);</span><br><span class="line">        x *= y;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">inline</span> <span class="keyword">bool</span> <span class="title">blank</span><span class="params">(<span class="keyword">char</span> ch)</span> </span>&#123; <span class="keyword">return</span> ch == <span class="string">' '</span> || ch == <span class="string">'\n'</span> || ch == <span class="string">'\r'</span> || ch == <span class="string">'\t'</span>; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">read</span><span class="params">(<span class="keyword">char</span>* s)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">register</span> <span class="keyword">char</span> ch = gc();</span><br><span class="line">        <span class="keyword">for</span> (; blank(ch); ch = gc())</span><br><span class="line">            ;</span><br><span class="line">        <span class="keyword">for</span> (; !blank(ch); ch = gc()) *s++ = ch;</span><br><span class="line">        *s = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">read</span><span class="params">(<span class="keyword">char</span>&amp; c)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (c = gc(); blank(c); c = gc())</span><br><span class="line">            ;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">typename</span> Type, <span class="keyword">typename</span>... Args&gt;</span><br><span class="line">    <span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">read</span><span class="params">(Type&amp; t, Args&amp;... args)</span> </span>&#123;</span><br><span class="line">        read(t), read(args...);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">typename</span>... Args&gt;</span><br><span class="line">    <span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">read</span><span class="params">(<span class="keyword">char</span>* t, Args&amp;... args)</span> </span>&#123;</span><br><span class="line">        read(t), read(args...);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">typename</span>... Args&gt;</span><br><span class="line">    <span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">read</span><span class="params">(<span class="keyword">char</span>&amp; t, Args&amp;... args)</span> </span>&#123;</span><br><span class="line">        read(t), read(args...);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="class"><span class="keyword">class</span> <span class="title">Type</span>&gt;</span></span><br><span class="line"><span class="class">    <span class="title">inline</span> <span class="title">void</span> <span class="title">write</span>(<span class="title">char</span> <span class="title">lastChar</span>, <span class="title">Type</span> <span class="title">x</span>) &#123;</span></span><br><span class="line">        <span class="keyword">if</span> (x &lt; <span class="number">0</span>)</span><br><span class="line">            *oS++ = <span class="string">'-'</span>, x = -x;</span><br><span class="line">        <span class="keyword">if</span> (x == <span class="number">0</span>)</span><br><span class="line">            *oS++ = <span class="string">'0'</span>;</span><br><span class="line">        <span class="keyword">while</span> (x) fu[++fr] = x % <span class="number">10</span> + <span class="string">'0'</span>, x /= <span class="number">10</span>;</span><br><span class="line">        <span class="keyword">while</span> (fr) *oS++ = fu[fr--];</span><br><span class="line">        *oS++ = lastChar;</span><br><span class="line">        ioout();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(<span class="keyword">char</span> lastChar, <span class="keyword">char</span> x[])</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">register</span> <span class="keyword">int</span> i = <span class="number">0</span>; x[i]; ++i) *oS++ = x[i];</span><br><span class="line">        *oS++ = lastChar;</span><br><span class="line">        ioout();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(<span class="keyword">char</span> lastChar, <span class="keyword">char</span> x)</span> </span>&#123;</span><br><span class="line">        *oS++ = x;</span><br><span class="line">        *oS++ = lastChar;</span><br><span class="line">        ioout();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">typename</span> Type, <span class="keyword">typename</span>... Args&gt;</span><br><span class="line">    <span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(<span class="keyword">char</span> midChar, Type t, Args... args)</span> </span>&#123;</span><br><span class="line">        write(midChar, t), write(midChar, args...);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;  <span class="comment">// namespace Fast_IO</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> Fast_IO::read;</span><br><span class="line"><span class="keyword">using</span> Fast_IO::write;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> SIZE = <span class="number">5e4</span> + <span class="number">5</span>;</span><br><span class="line"><span class="keyword">namespace</span> ChainForwardStar &#123;</span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">int</span> SIZE = ::SIZE;</span><br><span class="line">	<span class="keyword">int</span> tot_, Vert[SIZE];</span><br><span class="line">	<span class="keyword">int</span> Head[SIZE], Next[SIZE];</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">AddLine</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y)</span> </span>&#123;</span><br><span class="line">		Vert[++tot_] = y;</span><br><span class="line">		Next[tot_] = Head[x];</span><br><span class="line">		Head[x] = tot_;</span><br><span class="line">	&#125;</span><br><span class="line">&#125; <span class="comment">// namespace ChainForwardStar</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> CFS::Head;</span><br><span class="line"><span class="keyword">using</span> CFS::Vert;</span><br><span class="line"><span class="keyword">using</span> CFS::Next;</span><br><span class="line"><span class="keyword">using</span> CFS::AddLine;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> TreeChainSplitting &#123;</span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">int</span> SIZE = ::SIZE;</span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">int</span> MOD = <span class="number">201314</span>;</span><br><span class="line">	<span class="keyword">int</span> n, m, tot, d[SIZE];</span><br><span class="line">	<span class="keyword">int</span> fa[SIZE], size[SIZE];</span><br><span class="line">	<span class="keyword">int</span> son[SIZE], top[SIZE];</span><br><span class="line">	<span class="keyword">int</span> dfn[SIZE], rnk[SIZE];</span><br><span class="line">	<span class="keyword">int</span> ask[SIZE], ans[SIZE];</span><br><span class="line">	<span class="built_in">vector</span> &lt; <span class="keyword">int</span> &gt; GFY[SIZE];</span><br><span class="line">	<span class="built_in">vector</span> &lt; <span class="keyword">int</span> &gt; FI[SIZE];</span><br><span class="line">	<span class="keyword">int</span> sum[SIZE &lt;&lt; <span class="number">2</span>], lf[SIZE &lt;&lt; <span class="number">2</span>];</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Prepare</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</span><br><span class="line">		size[x] = <span class="number">1</span>, d[x] = d[fa[x]] + <span class="number">1</span>;</span><br><span class="line">		<span class="keyword">for</span> (ForGraph)</span><br><span class="line">			Prepare(y), size[x] += size[y], CheckSize;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Prepare</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> tp)</span> </span>&#123;</span><br><span class="line">		rnk[dfn[x] = ++tot] = x, top[x] = tp;</span><br><span class="line">		<span class="keyword">if</span> (son[x]) Prepare(son[x], tp);</span><br><span class="line">		<span class="keyword">for</span> (ForGraph) <span class="keyword">if</span> (y ^ son[x]) Prepare(y, y);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">#<span class="meta-keyword">define</span> ls (k &lt;&lt; 1)</span></span><br><span class="line">	<span class="meta">#<span class="meta-keyword">define</span> rs (k &lt;&lt; 1 | 1)</span></span><br><span class="line">	<span class="meta">#<span class="meta-keyword">define</span> L_RECUR ls, l, mid, x, y</span></span><br><span class="line">	<span class="meta">#<span class="meta-keyword">define</span> R_RECUR rs, mid + 1, r, x, y</span></span><br><span class="line">	<span class="meta">#<span class="meta-keyword">define</span> UpdateSons(k, l, r) <span class="meta-keyword">if</span> (lf[k]) sum[ls] = (sum[ls] + 1LL * lf[k] * (mid - l + 1) % MOD) % MOD,					\</span></span><br><span class="line">								sum[rs] = (sum[rs] + <span class="number">1L</span>L * lf[k] * (r - mid) % MOD) % MOD, lf[ls] += lf[k],					\</span><br><span class="line">								lf[rs] += lf[k], lf[k] = <span class="number">0</span></span><br><span class="line">	#define UpdateMessages(k) sum[k] = (sum[ls] + sum[rs]) % MOD</span><br><span class="line">	<span class="keyword">void</span> ModifyChain(<span class="keyword">int</span> k, <span class="keyword">int</span> l, <span class="keyword">int</span> r, <span class="keyword">int</span> x, <span class="keyword">int</span> y) &#123;</span><br><span class="line">		<span class="keyword">if</span> (l &gt;= x &amp;&amp; r &lt;= y) sum[k] = (sum[k] + r - l + <span class="number">1</span>) % MOD, ++lf[k];</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			UpdateSons(k, l, r);</span><br><span class="line">			<span class="keyword">if</span> (mid &gt;= x) ModifyChain(L_RECUR);</span><br><span class="line">			<span class="keyword">if</span> (mid &lt; y) ModifyChain(R_RECUR);</span><br><span class="line">			UpdateMessages(k);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">ModifySubTree</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (x) ModifyChain(<span class="number">1</span>, <span class="number">1</span>, n, dfn[top[x]], dfn[x]), ModifySubTree(x = fa[top[x]]);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">int</span> <span class="title">QueryChain</span><span class="params">(<span class="keyword">int</span> k, <span class="keyword">int</span> l, <span class="keyword">int</span> r, <span class="keyword">int</span> x, <span class="keyword">int</span> y, <span class="keyword">int</span> res = <span class="number">0</span>)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (l &gt;= x &amp;&amp; r &lt;= y) <span class="keyword">return</span> sum[k];</span><br><span class="line">		UpdateSons(k, l, r);</span><br><span class="line">		<span class="keyword">if</span> (mid &gt;= x) res += QueryChain(L_RECUR, <span class="number">0</span>);</span><br><span class="line">		<span class="keyword">if</span> (mid &lt; y) res += QueryChain(R_RECUR, <span class="number">0</span>);</span><br><span class="line">		<span class="keyword">return</span> res;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">int</span> <span class="title">QuerySubTree</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> res = <span class="number">0</span>)</span> </span>&#123; <span class="comment">// luogu-only </span></span><br><span class="line">		<span class="keyword">if</span> (x) QuerySubTree((res += QueryChain(<span class="number">1</span>, <span class="number">1</span>, n, dfn[top[x]], dfn[x]), x = fa[top[x]]), res); <span class="keyword">else</span> <span class="keyword">return</span> res;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line"><span class="comment">//	int QuerySubTree(int x, int res = 0) &#123; // loj-only</span></span><br><span class="line"><span class="comment">//		while (x) &#123;</span></span><br><span class="line"><span class="comment">//			res += QueryChain(1, 1, n, dfn[top[x]], dfn[x]);</span></span><br><span class="line"><span class="comment">//			x = fa[top[x]];</span></span><br><span class="line"><span class="comment">//		&#125;</span></span><br><span class="line"><span class="comment">//		return res;</span></span><br><span class="line"><span class="comment">//	&#125;</span></span><br><span class="line">&#125; <span class="comment">// namespace TreeChainSplitting</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> ProblemSolver &#123;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		read(TCS::n), read(TCS::m);</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">2</span>; i &lt;= TCS::n; ++i) read(TCS::fa[i]), AddLine(++TCS::fa[i], i);</span><br><span class="line">		TCS::Prepare(<span class="number">1</span>), TCS::tot = <span class="number">0</span>, TCS::Prepare(<span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">		<span class="keyword">int</span> L, R;</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= TCS::m; ++i) read(L, R, TCS::ask[i]), TCS::FI[L].push_back(i), TCS::GFY[R + <span class="number">1</span>].push_back(i), ++TCS::ask[i];</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= TCS::n; ++i) &#123;</span><br><span class="line">			TCS::ModifySubTree(i);</span><br><span class="line">			<span class="keyword">for</span> (<span class="keyword">auto</span> it : TCS::GFY[i]) TCS::ans[it] += TCS::QuerySubTree(TCS::ask[it]);</span><br><span class="line">			<span class="keyword">for</span> (<span class="keyword">auto</span> it : TCS::FI[i]) TCS::ans[it] -= TCS::QuerySubTree(TCS::ask[it]);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= TCS::m; ++i) write(io_l, (TCS::ans[i] % TCS::MOD + TCS::MOD) % TCS::MOD);</span><br><span class="line">	&#125;</span><br><span class="line">&#125; <span class="comment">// namespace ProblemSover</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">signed</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	PS::main();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="25-「2018-集训队互测-Day-3」北校门外的未来"><a href="#25-「2018-集训队互测-Day-3」北校门外的未来" class="headerlink" title="25.「2018 集训队互测 Day 3」北校门外的未来"></a>25.「2018 集训队互测 Day 3」北校门外的未来</h1><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>这道题绝对是我目前来说做题用时最长的一道题（总共花了我五天时间左右）</p>
<p>说一下我这几天的心路历程吧：</p>
<blockquote>
<p>Day1:嗯？我好像发现了一道有趣的题目？洛谷上好像没有。。算了，做一下试试。。。</p>
<p>Day2:cow，这道题是道什么题？口胡一下LCT？算了算了看看题解。。。笛卡尔树是什么？？学吧学吧。。。</p>
<p>Day3：上半天：cow学不动了。。。更一下博客吧(<a href="https://www.orchid-any.cf/">广告位</a>)；下半天：继续吧。。。</p>
<p>Day4:上半天：好像有点想法了。。。完善一下。。找找锅。。；下半天(确切的说是晚上。。)：开始码咯！</p>
<p>Day5：上半天：调了5个小时后过了；下半天：写写题解咯</p>
</blockquote>
<h1 id="正文"><a href="#正文" class="headerlink" title="正文"></a>正文</h1><h2 id="Description"><a href="#Description" class="headerlink" title="Description"></a>Description</h2><blockquote>
<p>如果你不想阅读故事，请直接跳到题意部分。</p>
</blockquote>
<p>转眼间，已是三年流转。</p>
<p>夏日法桐的绿荫，代替了秋季的萧索，衬托着 LCR 和神犇成长的背影。</p>
<p>身后的北校门，也不再是当年学生试图摧毁的，束缚自由的枷锁，而成了青春记忆的符号。</p>
<p>又到了神犇和 LCR 相遇的地方 —— 北校门外的树下。这棵神奇的树早已不是 K 项树的形态。每时每刻，它都以新的独特方式演绎着生命。</p>
<p>谁也没有开口，他和她静静地注视着魔法般生长的自然种子。初始时，这棵树只有一个点，LCR 将其标号为 $1$。此后，每过一段时间，就会有一个新节点从原有的某个点出生长出来，LCR 会给它分配一个尚未使用过的不超过 $n$ 的正整数编号。</p>
<p>树中生活着一些小精灵。它们总停留在节点上，如果一个精灵在编号 $u$ 的节点，那么它可以一步跳到任何编号 $v$ 的满足 $u,v$ 之间的简单路径上不存在异于 $u,v$ 的编号大于 $\min(u,v)$ 的点处。</p>
<p>在观察这棵树的过程中，LCR 产生了一些疑问。她想知道，对于一对节点编号 $u,v$，从节点 $u$ 跳到节点 $v$ 最少需要几步。</p>
<p>神犇轻松地解决了这些问题。最终，树渐渐停止了生长，但神犇仍然陶醉其中。</p>
<p>一只飘渺的手搭上了神犇的肩膀。他回过头，看到 LCR 正在微笑。</p>
<p><em>“亲爱的少年，神犇君。”</em></p>
<p><em>“你是否想过，为什么精灵会依照我编号的法则而运动呢？”</em></p>
<p>神犇一时语塞。瞬间，LCR 的手变得虚幻了起来，如同明灭的火炬。</p>
<p><em>“你的成长，是这变化世界的一个切面。感谢你与我度过的时光。不要留恋 …… 我的随风飘散，正是与你们同在。”</em></p>
<p><em>“再见了，神犇君。”</em></p>
<p>LCR 消失了，神犇机械地转过身，却发现背后的树也已消失无踪。</p>
<p><em>“神犇，神犇 ……”</em> 茫然若失的神犇背后传来了渐行渐近的呼叫。神犇转过身，发现机房里的蒟蒻 LCA 正向他跑来。</p>
<p><em>“又是一年毕业季了呢。学长你还好吗？”</em></p>
<p><em>“也许吧。”</em> 神犇望向校门外的树原先的位置，<em>“LCR 走了，但她的背影会吸引着我们的人生。”</em></p>
<p>LCA 沉默了。他和神犇一同望向树消失的地方，持续片刻。</p>
<p><em>“所谓中二的幻想，才是我们相对的有限的主观能动性唯一的立场吧，不要给自己设限啊，LCA。我们去追寻她 …… 追寻自然的精灵。也许这就是我们的初心也说不定。”</em></p>
<p>这次是 LCA 目送神犇的背影渐行渐远了。</p>
<p><em>“再见了，学长。”</em></p>
<p>某少女附中，又迎来了新的一年。</p>
<p>那么，你能够回答 LCR 提出的问题吗？</p>
<hr>
<h3 id="题意"><a href="#题意" class="headerlink" title="题意"></a>题意</h3><p>对于一棵树 $T=(V,E)$，$V$ 中每个点有一个互不相同的正整数标号。我们用点 $i$ 表示编号为 $i$ 的点。</p>
<p>定义这棵树的<strong>谷图</strong>为 $G(T)=(V,E’)$。$G(T)$ 是无向简单图。存在边 $(u,v)\in E’$ 当且仅当在 $T$ 中，不存在一个异于 $u,v$ 的点 $x$ 满足 $x$ 在从 $u$ 到 $v$ 的简单路径上且其编号大于 $\min(u,v)$。</p>
<p>有一棵树 $T$，初始时只有一个点，编号为 $1$，接下来有 $q$ 次操作，操作有以下两种：</p>
<ul>
<li>$\texttt{1 u v}$ 表示加入一个编号为 $v$ 的节点并与当前编号为 $u$ 的节点相连（保证任何时刻不会有两个编号相同的节点）；</li>
<li>$\texttt{2 u v}$ 表示查询 $G(T)$ 中点 $u$ 到 $v$ 的最短路（每条边长度均为 $1$）。</li>
</ul>
<p>请你回答所有查询。</p>
<hr>
<p>题目好长咳咳咳。。。（最关键的是我读完过后重读一遍发现背景与题目无关。。。靠!</p>
<p>不扯了说正事儿。。。</p>
<p>动态问题其实很烦人对吧？这里我们可以假设原问题为静态问题。</p>
<p>静态问题就很好处理对吧？都是显然做法。那么问题又回到动态问题，对于加点操作，事实上我的做法十分**，利用Splay的性质乱搞。打出了一个像模拟一样的东西</p>
<p>其实我也不太清楚我是怎么过的。。。因为我的做法很玄学+暴力，所以。。。大家意会一下。</p>
<p>如果实在要看题解的话，我这里有一篇，不过估计也没人能看懂，反正你看了就知道了。至于其他的题解<del>想都别想了我翻墙去隔壁Google都没找到</del>，基本上是找不<br>道的。。。<a href="https://www.codeleading.com/article/774394821/" target="_blank" rel="noopener">Link</a></p>
<p>放个代码，大家意会一下。。。(404行好评)</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> GCC diagnostic <span class="meta-keyword">error</span> <span class="meta-string">"-std=c++11"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstdio&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;algorithm&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstring&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;queue&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SIZE_CHECKER ((size[son[x]] &lt; size[y]) &amp;&amp; (son[x] = y))</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> pii pair <span class="meta-string">&lt; int , int &gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> pll pair <span class="meta-string">&lt; LL, LL &gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> mid ((l + r) &gt;&gt; 1)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> mp make_pair</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> fir first</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> sec second</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> pub push_back</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> pob pop_back</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">long</span> <span class="keyword">long</span> LL;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> io_e <span class="meta-string">'\0'</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> io_s <span class="meta-string">' '</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> io_l <span class="meta-string">'\n'</span></span></span><br><span class="line"><span class="comment">//  #define _DEBUG_ 1 // debug toggle</span></span><br><span class="line"><span class="keyword">namespace</span> Fast_IO &#123;</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">ifndef</span> _DEBUG_</span></span><br><span class="line">        <span class="meta">#<span class="meta-keyword">define</span> gc() (iS == iT ? (iT = (iS = ibuff) + fread(ibuff, 1, SIZ, stdin), (iS == iT ? EOF : *iS++)) : *iS++)</span></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">        <span class="meta">#<span class="meta-keyword">define</span> gc() getchar()</span></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">int</span> SIZ = <span class="number">1</span> &lt;&lt; <span class="number">21</span> | <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">char</span> *iS, *iT, ibuff[SIZ], obuff[SIZ], *oS = obuff, *oT = oS + SIZ - <span class="number">1</span>, fu[<span class="number">110</span>], c;</span><br><span class="line">    <span class="keyword">int</span> fr;</span><br><span class="line">    <span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">ioout</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        fwrite(obuff, <span class="number">1</span>, oS - obuff, <span class="built_in">stdout</span>);</span><br><span class="line">        oS = obuff;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="class"><span class="keyword">class</span> <span class="title">Type</span>&gt;</span></span><br><span class="line"><span class="class">    <span class="title">inline</span> <span class="title">void</span> <span class="title">read</span>(<span class="title">Type</span>&amp; <span class="title">x</span>) &#123;</span></span><br><span class="line">        x = <span class="number">0</span>;</span><br><span class="line">        Type y = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">for</span> (c = gc(); (c &gt; <span class="string">'9'</span> || c &lt; <span class="string">'0'</span>) &amp;&amp; c ^ <span class="string">'-'</span>; c = gc())</span><br><span class="line">            ;</span><br><span class="line">        c == <span class="string">'-'</span> ? y = <span class="number">-1</span> : x = (c &amp; <span class="number">15</span>);</span><br><span class="line">        <span class="keyword">for</span> (c = gc(); c &gt;= <span class="string">'0'</span> &amp;&amp; c &lt;= <span class="string">'9'</span>; c = gc()) x = x * <span class="number">10</span> + (c &amp; <span class="number">15</span>);</span><br><span class="line">        x *= y;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">inline</span> <span class="keyword">bool</span> <span class="title">blank</span><span class="params">(<span class="keyword">char</span> ch)</span> </span>&#123; <span class="keyword">return</span> ch == <span class="string">' '</span> || ch == <span class="string">'\n'</span> || ch == <span class="string">'\r'</span> || ch == <span class="string">'\t'</span>; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">read</span><span class="params">(<span class="keyword">char</span>* s)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">register</span> <span class="keyword">char</span> ch = gc();</span><br><span class="line">        <span class="keyword">for</span> (; blank(ch); ch = gc())</span><br><span class="line">            ;</span><br><span class="line">        <span class="keyword">for</span> (; !blank(ch); ch = gc()) *s++ = ch;</span><br><span class="line">        *s = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">read</span><span class="params">(<span class="keyword">char</span>&amp; c)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (c = gc(); blank(c); c = gc())</span><br><span class="line">            ;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">typename</span> Type, <span class="keyword">typename</span>... Args&gt;</span><br><span class="line">    <span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">read</span><span class="params">(Type&amp; t, Args&amp;... args)</span> </span>&#123;</span><br><span class="line">        read(t), read(args...);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">typename</span>... Args&gt;</span><br><span class="line">    <span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">read</span><span class="params">(<span class="keyword">char</span>* t, Args&amp;... args)</span> </span>&#123;</span><br><span class="line">        read(t), read(args...);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">typename</span>... Args&gt;</span><br><span class="line">    <span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">read</span><span class="params">(<span class="keyword">char</span>&amp; t, Args&amp;... args)</span> </span>&#123;</span><br><span class="line">        read(t), read(args...);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="class"><span class="keyword">class</span> <span class="title">Type</span>&gt;</span></span><br><span class="line"><span class="class">    <span class="title">inline</span> <span class="title">void</span> <span class="title">write</span>(<span class="title">char</span> <span class="title">lastChar</span>, <span class="title">Type</span> <span class="title">x</span>) &#123;</span></span><br><span class="line">        <span class="keyword">if</span> (x &lt; <span class="number">0</span>)</span><br><span class="line">            *oS++ = <span class="string">'-'</span>, x = -x;</span><br><span class="line">        <span class="keyword">if</span> (x == <span class="number">0</span>)</span><br><span class="line">            *oS++ = <span class="string">'0'</span>;</span><br><span class="line">        <span class="keyword">while</span> (x) fu[++fr] = x % <span class="number">10</span> + <span class="string">'0'</span>, x /= <span class="number">10</span>;</span><br><span class="line">        <span class="keyword">while</span> (fr) *oS++ = fu[fr--];</span><br><span class="line">        *oS++ = lastChar;</span><br><span class="line">        ioout();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(<span class="keyword">char</span> lastChar, <span class="keyword">char</span> x[])</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">register</span> <span class="keyword">int</span> i = <span class="number">0</span>; x[i]; ++i) *oS++ = x[i];</span><br><span class="line">        *oS++ = lastChar;</span><br><span class="line">        ioout();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(<span class="keyword">char</span> lastChar, <span class="keyword">char</span> x)</span> </span>&#123;</span><br><span class="line">        *oS++ = x;</span><br><span class="line">        *oS++ = lastChar;</span><br><span class="line">        ioout();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">typename</span> Type, <span class="keyword">typename</span>... Args&gt;</span><br><span class="line">    <span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(<span class="keyword">char</span> midChar, Type t, Args... args)</span> </span>&#123;</span><br><span class="line">        write(midChar, t), write(midChar, args...);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;  <span class="comment">// namespace Fast_IO</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> Fast_IO::read;</span><br><span class="line"><span class="keyword">using</span> Fast_IO::write;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> SIZE = <span class="number">5e5</span> + <span class="number">5</span>;</span><br><span class="line"><span class="built_in">vector</span> &lt; <span class="built_in">vector</span> &lt; <span class="keyword">int</span> &gt; &gt; G(SIZE);</span><br><span class="line"><span class="keyword">int</span> n, m, st[SIZE], tp, F[SIZE];</span><br><span class="line"><span class="keyword">int</span> _time[SIZE], _down[SIZE];</span><br><span class="line"><span class="keyword">int</span> OP[SIZE], U[SIZE], V[SIZE];</span><br><span class="line">	</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">(<span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; ++i)</span><br><span class="line">		F[i] = i;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">find</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (x ^ F[x]) F[x] = find(F[x]);</span><br><span class="line">	<span class="keyword">return</span> F[x];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> CartesianTree &#123;</span><br><span class="line">	<span class="built_in">vector</span> &lt; <span class="built_in">vector</span> &lt; <span class="keyword">int</span> &gt; &gt; GCT(SIZE);</span><br><span class="line">	<span class="keyword">int</span> son[SIZE], fa[SIZE];</span><br><span class="line">	<span class="keyword">int</span> top[SIZE], size[SIZE];</span><br><span class="line">	<span class="keyword">int</span> low[SIZE], d[SIZE];</span><br><span class="line">	<span class="keyword">int</span> tot, ls[SIZE], rs[SIZE];</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Prepare1</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">while</span> (_time[st[tp]] &gt; _time[x] &amp;&amp; tp) _down[st[tp--]] = x;</span><br><span class="line">		st[++tp] = x;</span><br><span class="line">		size[x] = <span class="number">1</span>;</span><br><span class="line">		d[x] = d[fa[x]] + <span class="number">1</span>;</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">auto</span> y : GCT[x])</span><br><span class="line">			Prepare1((fa[y] = x, y)), size[x] += size[y], SIZE_CHECKER;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Prepare2</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</span><br><span class="line">		ls[x] = ++tot;</span><br><span class="line">		<span class="keyword">if</span> (!top[x]) top[x] = x;</span><br><span class="line">		<span class="keyword">if</span> (!son[x]) <span class="keyword">return</span> (<span class="keyword">void</span>)(rs[x] = tot);</span><br><span class="line">		top[son[x]] = top[x];</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">auto</span> y : GCT[x]) Prepare2(y);</span><br><span class="line">		rs[x] = tot;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">int</span> <span class="title">GetLCA</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">while</span> (top[x] ^ top[y])</span><br><span class="line">			d[top[x]] &gt; d[top[y]] ? x = fa[top[x]] : y = fa[top[y]];</span><br><span class="line">		<span class="keyword">return</span> d[x] &lt; d[y] ? x : y;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">int</span> <span class="title">Behavior</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">while</span> (top[x] ^ top[y]) <span class="keyword">if</span> (fa[x = top[x]] ^ y) x = fa[x]; <span class="keyword">else</span> <span class="keyword">return</span> x;</span><br><span class="line">		<span class="keyword">return</span> son[y];</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">bool</span> <span class="title">FindRule</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> ls[x] &lt; ls[y];</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">bool</span> <span class="title">CheckForFun</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">int</span> <span class="built_in">std</span> = *(upper_bound(GCT[y].begin(), GCT[y].end(), x, FindRule) - <span class="number">1</span>);</span><br><span class="line">		<span class="keyword">return</span> !(ls[low[<span class="built_in">std</span>]] &gt; rs[x] || ls[x] &gt; ls[low[<span class="built_in">std</span>]]);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		init(n);</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; ++i)</span><br><span class="line">			<span class="keyword">for</span> (<span class="keyword">auto</span> j : G[i])</span><br><span class="line">				<span class="keyword">if</span> (i &gt; find(j)) GCT[i].pub(find(j)), F[find(j)] = i;</span><br><span class="line">		Prepare1(n), Prepare2(n);</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; ++i)</span><br><span class="line">			<span class="keyword">for</span> (<span class="keyword">auto</span> j : G[i])</span><br><span class="line">				<span class="keyword">if</span> (i &gt; j) low[Behavior(j, i)] = j;</span><br><span class="line">	&#125;</span><br><span class="line">&#125; <span class="comment">// namespace CartesianTree</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CT CartesianTree</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> LinkCutTree &#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">SPLAY</span> &#123;</span></span><br><span class="line">		<span class="keyword">int</span> ch[<span class="number">2</span>];</span><br><span class="line">		<span class="keyword">int</span> fa;</span><br><span class="line">		<span class="keyword">int</span> sum;</span><br><span class="line">		<span class="keyword">int</span> key;</span><br><span class="line">	&#125; data[SIZE];</span><br><span class="line">	<span class="keyword">int</span> next[SIZE], root[SIZE];</span><br><span class="line">	<span class="meta">#<span class="meta-keyword">define</span> WhichSon(x) (data[data[x].fa].ch[1] == x)</span></span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">UpdateMessages</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</span><br><span class="line">		data[x].sum = data[data[x].ch[<span class="number">0</span>]].sum + data[data[x].ch[<span class="number">1</span>]].sum + data[x].key;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">RotateNode</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">int</span> y = data[x].fa, z = data[y].fa;</span><br><span class="line">		<span class="keyword">int</span> k = WhichSon(x);</span><br><span class="line">		<span class="keyword">if</span> (root[y]) root[y] = <span class="number">0</span>, root[x] = root[y] ^ <span class="number">1</span>;</span><br><span class="line">		<span class="keyword">else</span> data[z].ch[data[z].ch[<span class="number">1</span>] == y] = x;</span><br><span class="line">		data[x].fa = data[y].fa;</span><br><span class="line">		data[y].ch[k] = data[x].ch[k ^ <span class="number">1</span>];</span><br><span class="line">		<span class="keyword">if</span> (data[y].ch[k]) data[data[x].ch[k ^ <span class="number">1</span>]].fa = y;</span><br><span class="line">		data[x].ch[k ^ <span class="number">1</span>] = y;</span><br><span class="line">		data[y].fa = x;</span><br><span class="line">		UpdateMessages(y), UpdateMessages(x);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">SplayToRoot</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> y; !root[x]; RotateNode(x))</span><br><span class="line">			<span class="keyword">if</span> (!root[y = data[x].fa])</span><br><span class="line">				RotateNode(data[data[y].fa].ch[<span class="number">0</span>] ^ y ^ data[y].ch[<span class="number">0</span>] ^ x ? x : y);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">AccessEdge</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> y = <span class="number">0</span>; x; x = data[y = x].fa) &#123;</span><br><span class="line">			SplayToRoot(x);</span><br><span class="line">			<span class="keyword">if</span> (data[x].ch[<span class="number">1</span>]) root[data[x].ch[<span class="number">1</span>]] = <span class="number">1</span>;</span><br><span class="line">			<span class="keyword">if</span> (data[x].ch[<span class="number">1</span>] = y) root[y] = <span class="number">0</span>;</span><br><span class="line">			UpdateMessages(x);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Behavior</span><span class="params">(<span class="keyword">int</span> u, <span class="keyword">int</span> v)</span> </span>&#123;</span><br><span class="line">	    <span class="keyword">if</span> (u &gt; v) &#123;</span><br><span class="line">            F[v] = u;</span><br><span class="line">            data[v].fa = u;</span><br><span class="line">            data[v].key = <span class="number">1</span>;</span><br><span class="line">            data[v].sum = <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">return</span> ;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> x = _down[v], rhs = u;</span><br><span class="line">        SplayToRoot(x);</span><br><span class="line">        <span class="keyword">int</span> rsp = <span class="number">0</span>, cpy = <span class="number">0</span>, now = data[x].ch[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">if</span> (now) &#123;</span><br><span class="line">            <span class="keyword">while</span> (data[now].ch[<span class="number">1</span>]) now = data[now].ch[<span class="number">1</span>];</span><br><span class="line">            SplayToRoot(now);</span><br><span class="line">            <span class="keyword">while</span> (data[x].fa ^ now) RotateNode(x);</span><br><span class="line">            root[x] = <span class="number">1</span>;</span><br><span class="line">			data[now].ch[<span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">			UpdateMessages(now);</span><br><span class="line">        &#125;</span><br><span class="line">        now = data[x].fa;</span><br><span class="line">        <span class="keyword">if</span> (next[now] == x) next[now] = v;</span><br><span class="line">        data[v].key = data[v].sum = data[x].key;</span><br><span class="line">        <span class="keyword">if</span> (now) next[v] = x;</span><br><span class="line">        SplayToRoot(x);</span><br><span class="line">		data[x].fa = v;</span><br><span class="line">		data[v].fa = now;</span><br><span class="line">		data[x].key = <span class="number">0</span>;</span><br><span class="line">		UpdateMessages(x);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (u) &#123;</span><br><span class="line">            SplayToRoot(u);</span><br><span class="line">            <span class="keyword">if</span> (data[u].ch[<span class="number">1</span>]) root[data[u].ch[<span class="number">1</span>]] = <span class="number">1</span>;</span><br><span class="line">            data[u].ch[<span class="number">1</span>] = rsp;</span><br><span class="line">            <span class="keyword">if</span> (data[u].ch[<span class="number">1</span>]) root[rsp] = <span class="number">0</span>;</span><br><span class="line">            UpdateMessages(u);</span><br><span class="line">            <span class="keyword">if</span> (data[u].sum) &#123;</span><br><span class="line">            	x = u;</span><br><span class="line">                <span class="keyword">while</span> (<span class="number">233</span>)</span><br><span class="line">                    <span class="keyword">if</span> (data[x].ch[<span class="number">1</span>] &amp;&amp; data[data[x].ch[<span class="number">1</span>]].sum) x = data[x].ch[<span class="number">1</span>];</span><br><span class="line">                    <span class="keyword">else</span> <span class="keyword">if</span> (!data[x].key) x = data[x].ch[<span class="number">0</span>];</span><br><span class="line">                    <span class="keyword">else</span> <span class="keyword">break</span>;</span><br><span class="line">                SplayToRoot(x);</span><br><span class="line">                <span class="keyword">if</span> (x &gt;= v) <span class="keyword">break</span>;</span><br><span class="line">                u = data[x].ch[<span class="number">0</span>];</span><br><span class="line">                <span class="keyword">if</span> (u) &#123;</span><br><span class="line">                    <span class="keyword">while</span> (data[u].ch[<span class="number">1</span>]) u = data[u].ch[<span class="number">1</span>];</span><br><span class="line">                    SplayToRoot(u);</span><br><span class="line">                    data[u].ch[<span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">					root[x] = <span class="number">1</span>;</span><br><span class="line">                    UpdateMessages(u);</span><br><span class="line">                &#125;</span><br><span class="line">				<span class="keyword">else</span> u = data[x].fa;</span><br><span class="line">                <span class="keyword">if</span> (u &gt;= v) <span class="keyword">break</span>;</span><br><span class="line">                SplayToRoot(rhs);</span><br><span class="line">                <span class="keyword">if</span> (now = data[rhs].ch[<span class="number">1</span>]) root[now] = <span class="number">1</span>, data[rhs].ch[<span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">if</span> (now = next[rhs]) &#123;</span><br><span class="line">                    SplayToRoot(now);</span><br><span class="line">                    data[now].fa = u;</span><br><span class="line">                    data[now].key = <span class="number">1</span>;</span><br><span class="line">                    UpdateMessages(now);</span><br><span class="line">                    next[rhs] = <span class="number">0</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                u = F[x];</span><br><span class="line">				rhs = F[x];</span><br><span class="line">                data[x].key = <span class="number">0</span>;</span><br><span class="line">                UpdateMessages(x);</span><br><span class="line">                SplayToRoot(x);</span><br><span class="line">                <span class="keyword">while</span> (data[x].ch[<span class="number">1</span>]) x = data[x].ch[<span class="number">1</span>];</span><br><span class="line">                SplayToRoot(x);</span><br><span class="line">                data[x].ch[<span class="number">1</span>] = cpy;</span><br><span class="line">                <span class="keyword">if</span> (data[x].ch[<span class="number">1</span>]) &#123;</span><br><span class="line">                    data[cpy].fa = x, root[cpy] = <span class="number">0</span>, data[x].ch[<span class="number">1</span>] = cpy;</span><br><span class="line">                    <span class="keyword">while</span> (data[cpy].ch[<span class="number">0</span>]) cpy = data[cpy].ch[<span class="number">0</span>];</span><br><span class="line">                    next[x] = cpy;</span><br><span class="line">                    SplayToRoot(cpy);</span><br><span class="line">                &#125;</span><br><span class="line">                SplayToRoot(x);</span><br><span class="line">                cpy = x;</span><br><span class="line">                rsp = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">			<span class="keyword">else</span> rsp = u, u = data[u].fa;</span><br><span class="line">        &#125;</span><br><span class="line">        F[v] = F[_down[v]];</span><br><span class="line">		F[_down[v]] = v;</span><br><span class="line">        <span class="keyword">if</span> (!F[v]) &#123;</span><br><span class="line">            SplayToRoot(v);</span><br><span class="line">            x = v;</span><br><span class="line">            <span class="keyword">while</span> (data[x].ch[<span class="number">1</span>]) x = data[x].ch[<span class="number">1</span>];</span><br><span class="line">            <span class="keyword">if</span> (cpy) &#123;</span><br><span class="line">                data[x].ch[<span class="number">1</span>] = cpy;</span><br><span class="line">                root[cpy] = <span class="number">0</span>;</span><br><span class="line">                data[cpy].fa = x;</span><br><span class="line">                <span class="keyword">while</span> (data[cpy].ch[<span class="number">0</span>]) cpy = data[cpy].ch[<span class="number">0</span>];</span><br><span class="line">                next[x] = cpy;</span><br><span class="line">                SplayToRoot(cpy);</span><br><span class="line">            &#125;</span><br><span class="line">            SplayToRoot(v);</span><br><span class="line">            x = data[v].ch[<span class="number">1</span>];</span><br><span class="line">            <span class="keyword">while</span> (data[x].ch[<span class="number">0</span>]) x = data[x].ch[<span class="number">0</span>];</span><br><span class="line">            data[x].key = <span class="number">1</span>;</span><br><span class="line">            UpdateMessages(x);</span><br><span class="line">            SplayToRoot(x);</span><br><span class="line">        &#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (cpy) &#123;</span><br><span class="line">        	x = cpy;</span><br><span class="line">            <span class="keyword">while</span> (data[x].ch[<span class="number">0</span>]) x = data[x].ch[<span class="number">0</span>];</span><br><span class="line">            data[x].key = <span class="number">1</span>;</span><br><span class="line">			UpdateMessages(x);</span><br><span class="line">            SplayToRoot(x);</span><br><span class="line">            data[x].fa = v;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function">pii <span class="title">GetDis</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> t)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (x ^ t) &#123;</span><br><span class="line">			AccessEdge(x);</span><br><span class="line">			SplayToRoot(x);</span><br><span class="line">			<span class="keyword">int</span> st = x;</span><br><span class="line">			<span class="keyword">int</span> fir = <span class="number">0</span>, sec = <span class="number">0</span>;</span><br><span class="line">			<span class="keyword">while</span> (x)</span><br><span class="line">				<span class="keyword">if</span> (x &lt; t) sec = x, x = data[x].ch[<span class="number">0</span>];</span><br><span class="line">				<span class="keyword">else</span> x = data[x].ch[<span class="number">1</span>];</span><br><span class="line">			SplayToRoot(sec);</span><br><span class="line">			x = data[sec].ch[<span class="number">1</span>];</span><br><span class="line">			fir = data[x].sum;</span><br><span class="line">			<span class="keyword">if</span> (!fir) <span class="keyword">return</span> mp(<span class="number">0</span>, st);</span><br><span class="line">			<span class="keyword">while</span> (<span class="number">233</span>) &#123;</span><br><span class="line">				<span class="keyword">if</span> (data[data[x].ch[<span class="number">0</span>]].sum) x = data[x].ch[<span class="number">0</span>];</span><br><span class="line">				<span class="keyword">else</span> <span class="keyword">if</span> (!data[x].key) sec = x, x = data[x].ch[<span class="number">1</span>];</span><br><span class="line">				<span class="keyword">else</span> &#123;</span><br><span class="line">					<span class="keyword">if</span> (data[x].ch[<span class="number">0</span>]) &#123;</span><br><span class="line">						x = data[x].ch[<span class="number">0</span>];</span><br><span class="line">						<span class="keyword">while</span> (data[x].ch[<span class="number">1</span>]) x = data[x].ch[<span class="number">1</span>];</span><br><span class="line">						sec = x;</span><br><span class="line">					&#125;</span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">return</span> mp(fir, sec);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">return</span> mp(<span class="number">0</span>, x);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">int</span> <span class="title">GetAnswers</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (x ^ y) &#123;</span><br><span class="line">			<span class="keyword">if</span> (x &gt; y) x ^= y ^= x ^= y;</span><br><span class="line">			<span class="keyword">int</span> sys = CT::GetLCA(x, y);</span><br><span class="line">			<span class="keyword">if</span> (sys ^ y) &#123;</span><br><span class="line">				pii t1 = GetDis(x, sys);</span><br><span class="line">				pii t2 = GetDis(y, sys);</span><br><span class="line">				<span class="keyword">return</span> t1.fir + t2.fir + ((CT::CheckForFun(t1.sec, sys)</span><br><span class="line">					 &amp;&amp; CT::CheckForFun(t2.sec, sys)) ^ <span class="number">1</span>) + <span class="number">2</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> &#123;</span><br><span class="line">				pii t = GetDis(x, sys);</span><br><span class="line">				<span class="keyword">return</span> t.fir + (CT::CheckForFun(t.sec, sys) ^ <span class="number">1</span>) + <span class="number">1</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125; <span class="comment">// namespace LinkCutTree</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LCT LinkCutTree</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> SOLVER &#123;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		read(m), read(m);</span><br><span class="line">		n = <span class="number">1</span>;</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= m; ++i) &#123;</span><br><span class="line">			read(OP[i], U[i], V[i]);</span><br><span class="line">			<span class="keyword">if</span> (OP[i] ^ <span class="number">1</span>) <span class="keyword">continue</span>;</span><br><span class="line">			G[U[i]].pub(V[i]);</span><br><span class="line">			G[V[i]].pub(U[i]);</span><br><span class="line">			_time[V[i]] = i;</span><br><span class="line">			n = max(n, V[i]);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; ++i) LCT::root[i] = <span class="literal">true</span>;</span><br><span class="line">		CT::Main();</span><br><span class="line">		F[<span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= m; ++i) &#123;</span><br><span class="line">			<span class="keyword">if</span> (OP[i] ^ <span class="number">2</span>) LCT::Behavior(U[i], V[i]);</span><br><span class="line">			<span class="keyword">else</span> write(io_l, LCT::GetAnswers(U[i], V[i]));</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">signed</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	SOLVER::Main();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="26-P1121-环状最大两段子段和"><a href="#26-P1121-环状最大两段子段和" class="headerlink" title="26.P1121 环状最大两段子段和"></a>26.P1121 环状最大两段子段和</h1><p>给出一段环状序列，即认为$A_1$和$A_N$是相邻的，选出其中连续不重叠且非空的两段使得这两段和最大。</p>
<hr>
<p>一共三个关键词:</p>
<blockquote>
<p>环状</p>
<p>最大</p>
<p>两段子段和</p>
</blockquote>
<p>显然这是一道DP题。。。然而我们可以把它搞成线段树!</p>
<p>普通的最大子段和相信大家都能够用线段树来完成。</p>
<p>无非就是记录区间和、区间最大子段和、区间最大前缀和、区间最大后缀和</p>
<p>然后合并时更新信息即可</p>
<p>那么两段子段和该怎么搞呢?</p>
<p>其实也不费脑子<del>废笔</del></p>
<p>首先套路的讨论这两段的位置，我们可以发现有5种情况（画画图示意一下可能很丑反正意思你们能懂就行</p>
<p><img src="https://i.loli.net/2020/02/07/cM8KnGyrefCLwRk.png" alt="Annotation 2020-02-07 210659.png"></p>
<p>总结出来我们需要在线段树里维护的东西有：</p>
<ol>
<li>区间和</li>
<li>区间最大前缀</li>
<li>区间最大后缀</li>
<li>区间最大子段和</li>
<li>区间最大前缀+后缀</li>
<li>区间最大中间+后缀</li>
<li>区间最大前缀+中间</li>
<li>区间两段最大子段和</li>
</ol>
<p><del>每行长度不下降看着还是很爽的。。。</del></p>
<p>具体实现看代码中的注释</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 省略快读和一堆预处理命令</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> SIZE = <span class="number">4e5</span> + <span class="number">5</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> INF = ~<span class="number">0U</span> &gt;&gt; <span class="number">1</span>;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">TreeNode</span> &#123;</span> <span class="comment">// 这里的意思应该很明确</span></span><br><span class="line">	<span class="keyword">int</span> sum;</span><br><span class="line">	<span class="keyword">int</span> maxSum;</span><br><span class="line">	<span class="keyword">int</span> maxSumDouble;</span><br><span class="line">	<span class="keyword">int</span> maxPrefixSum;</span><br><span class="line">	<span class="keyword">int</span> maxSuffixSum;</span><br><span class="line">	<span class="keyword">int</span> maxPrePlusSuf;</span><br><span class="line">	<span class="keyword">int</span> maxPrePlusMid;</span><br><span class="line">	<span class="keyword">int</span> maxSufPlusMid;</span><br><span class="line">&#125; data[SIZE&lt;&lt;<span class="number">2</span>];</span><br><span class="line"><span class="keyword">int</span> ints[SIZE&lt;&lt;<span class="number">1</span>], ans = -INF, n;</span><br><span class="line"></span><br><span class="line"><span class="function">TreeNode <span class="title">UpdateMessages</span><span class="params">(TreeNode x, TreeNode y)</span> </span>&#123; <span class="comment">// 这是重点</span></span><br><span class="line">	TreeNode res;</span><br><span class="line">	res.sum = x.sum + y.sum; <span class="comment">// 区间和标记上传</span></span><br><span class="line">	res.maxSum = max(x.maxSum, y.maxSum); <span class="comment">// // 区间最大子段和标记上传</span></span><br><span class="line">	res.maxSum = max(res.maxSum, x.maxSuffixSum + y.maxPrefixSum); <span class="comment">// 再把自己和两个儿子的最大前/后缀和的和比较</span></span><br><span class="line">	res.maxPrefixSum = max(x.maxPrefixSum, x.sum + y.maxPrefixSum); <span class="comment">// 其实下面都差不多</span></span><br><span class="line">	res.maxSuffixSum = max(y.maxSuffixSum, y.sum + x.maxSuffixSum); <span class="comment">// 实在不懂看上面的图</span></span><br><span class="line">	res.maxPrePlusSuf = max(x.maxPrefixSum + y.maxSuffixSum, x.sum + y.maxPrePlusSuf); <span class="comment">// 看了就明白了。。。</span></span><br><span class="line">	res.maxPrePlusSuf = max(res.maxPrePlusSuf, y.sum + x.maxPrePlusSuf);</span><br><span class="line">	res.maxPrePlusMid = max(x.maxPrePlusMid, x.sum + y.maxPrePlusMid);</span><br><span class="line">	res.maxPrePlusMid = max(res.maxPrePlusMid, x.maxPrefixSum + y.maxSum);</span><br><span class="line">	res.maxPrePlusMid = max(res.maxPrePlusMid, x.maxPrePlusSuf + y.maxPrefixSum);</span><br><span class="line">	res.maxSufPlusMid = max(y.maxSufPlusMid, y.sum + x.maxSufPlusMid);</span><br><span class="line">	res.maxSufPlusMid = max(res.maxSufPlusMid, y.sum + x.maxSum);</span><br><span class="line">	res.maxSufPlusMid = max(res.maxSufPlusMid, y.maxPrePlusSuf + x.maxSuffixSum);</span><br><span class="line">	res.maxSumDouble = max(x.maxSumDouble, y.maxSumDouble);</span><br><span class="line">	res.maxSumDouble = max(res.maxSumDouble, x.maxSum + y.maxSum);</span><br><span class="line">	res.maxSumDouble = max(res.maxSumDouble, x.maxSufPlusMid + y.maxPrefixSum);</span><br><span class="line">	res.maxSumDouble = max(res.maxSumDouble, x.maxSuffixSum + y.maxPrePlusMid);</span><br><span class="line">	<span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Initialization</span><span class="params">(<span class="keyword">int</span> k, <span class="keyword">int</span> l)</span> </span>&#123; <span class="comment">// 给线段树结点赋初值</span></span><br><span class="line">	data[k].sum = data[k].maxPrefixSum = data[k].maxSuffixSum = data[k].maxSum = ints[l];</span><br><span class="line">	data[k].maxSumDouble = data[k].maxPrePlusSuf = data[k].maxPrePlusMid = data[k].maxSufPlusMid = -INF;</span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">BuildTree</span><span class="params">(<span class="keyword">int</span> k, <span class="keyword">int</span> l, <span class="keyword">int</span> r)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (l ^ r) BuildTree(ls, l, mid), BuildTree(rs, mid + <span class="number">1</span>, r), data[k] = UpdateMessages(data[ls], data[rs]);</span><br><span class="line">	<span class="keyword">else</span> Initialization(k, l);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">TreeNode <span class="title">GetAnswers</span><span class="params">(<span class="keyword">int</span> k, <span class="keyword">int</span> l, <span class="keyword">int</span> r, <span class="keyword">int</span> x, <span class="keyword">int</span> y)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (l ^ x || r ^ y) &#123;</span><br><span class="line">		<span class="keyword">if</span> (mid &gt;= y) <span class="keyword">return</span> GetAnswers(ls, l, mid, x, y);</span><br><span class="line">		<span class="keyword">if</span> (mid &lt; x) <span class="keyword">return</span> GetAnswers(rs, mid + <span class="number">1</span>, r, x, y);</span><br><span class="line">		<span class="keyword">return</span> UpdateMessages(GetAnswers(ls, l, mid, x, mid), GetAnswers(rs, mid + <span class="number">1</span>, r, mid + <span class="number">1</span>, y));</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">return</span> data[k];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">signed</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	read(n);</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; ++i) read(ints[i]), ints[i + n] = ints[i];</span><br><span class="line">	BuildTree(<span class="number">1</span>, <span class="number">1</span>, n &lt;&lt; <span class="number">1</span>);</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; ++i) ans = max(ans, GetAnswers(<span class="number">1</span>, <span class="number">1</span>, n &lt;&lt; <span class="number">1</span>, i, i + n - <span class="number">1</span>).maxSumDouble);</span><br><span class="line">	write(io_l, ans);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="27-【中午的题目】分糖果"><a href="#27-【中午的题目】分糖果" class="headerlink" title="27.【中午的题目】分糖果"></a>27.【中午的题目】分糖果</h1><p>小 Z 带着新买的糖果来拜访舅舅家，舅舅家的 $K$ 个孩子看见小 Z 带着糖果来拜访变得欣喜若狂，他们都希望吃到好吃的糖果。正当小 Z 准备给 $K$ 个孩子分糖果时，舅舅却让小 Z 尽量少分点，免得孩子们蛀牙。</p>
<p>小 Z 带来的糖果比较特别，一共有 $N$ 个糖果连成一串，编号为 $1\ldots N$，第 $i$ 个糖果有一个数值 $a[i]$ 表示蛀牙的可能性，数值越大的糖果越容易导致蛀牙，多个糖果的蛀牙值认为是各个糖果的蛀牙值之和。</p>
<p>现在小 Z 打算取 $N$ 个糖果的前若干个，分成 $K$ 段分给 $K$ 个孩子。小 Z 好奇，他该怎么分糖果，才能使得分到糖果蛀牙值最大的孩子尽可能不蛀牙</p>
<hr>
<p>首先暴力做法显然。</p>
<p>首先前缀和然后对前缀和离散化</p>
<p>二分答案然后check里面dp，$dp_i$ 为区间 $[1,i]$ 最多能分成的块数。</p>
<p>dp方程显然为 $dp_i=max{dp_j}+1$。</p>
<p>这样转移是 $\Theta(n^2)$ 的，显然T飞。</p>
<p>考虑树状数组优化，需要区间最大值和单点修改操作。</p>
<p>时间复杂度 $\Theta(n\log^2n)$</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> GCC diagnostic <span class="meta-keyword">error</span> <span class="meta-string">"-std=c++11"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstdio&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;algorithm&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstring&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;queue&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ls (k &lt;&lt; 1)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> rs (k &lt;&lt; 1 | 1)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SIZE_CHECKER(x, y) ((size[son[x]] &lt; size[y]) &amp;&amp; (son[x] = y))</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PII pair <span class="meta-string">&lt; __int64 , __int64 &gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PLL pair <span class="meta-string">&lt; LL, LL &gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> mid ((l + r) &gt;&gt; 1)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> mp make_pair</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> fir first</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> sec second</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> pb push_back</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> R register</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> __int8</span></span><br><span class="line">	<span class="keyword">typedef</span> <span class="keyword">char</span> __int8;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> __uint8</span></span><br><span class="line">	<span class="keyword">typedef</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> __uint8;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> __int16</span></span><br><span class="line">	<span class="keyword">typedef</span> short __int16;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> __uint16</span></span><br><span class="line">	<span class="keyword">typedef</span> <span class="keyword">unsigned</span> short __uint16;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> __int32</span></span><br><span class="line">	<span class="keyword">typedef</span> <span class="keyword">int</span> __int32;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> __int64</span></span><br><span class="line">	<span class="keyword">typedef</span> <span class="keyword">long</span> <span class="keyword">long</span> __int64;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> __uint32</span></span><br><span class="line">	<span class="keyword">typedef</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> __uint32;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> __uint64</span></span><br><span class="line">	<span class="keyword">typedef</span> <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> __uint64;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> io_e <span class="meta-string">'\0'</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> io_s <span class="meta-string">' '</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> io_l <span class="meta-string">'\n'</span></span></span><br><span class="line"> <span class="meta">#<span class="meta-keyword">define</span> _DEBUG_ 1 <span class="comment">// debug toggle</span></span></span><br><span class="line"><span class="keyword">namespace</span> Fast_IO &#123;</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">ifndef</span> _DEBUG_</span></span><br><span class="line">        <span class="meta">#<span class="meta-keyword">define</span> gc() (iS == iT ? (iT = (iS = ibuff) + fread(ibuff, 1, SIZ, stdin), (iS == iT ? EOF : *iS++)) : *iS++)</span></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">        <span class="meta">#<span class="meta-keyword">define</span> gc() getchar()</span></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="keyword">const</span> __int64 SIZ = <span class="number">1</span> &lt;&lt; <span class="number">21</span> | <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">char</span> *iS, *iT, ibuff[SIZ], obuff[SIZ], *oS = obuff, *oT = oS + SIZ - <span class="number">1</span>, fu[<span class="number">110</span>], c;</span><br><span class="line">    __int64 fr;</span><br><span class="line">    <span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">ioout</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        fwrite(obuff, <span class="number">1</span>, oS - obuff, <span class="built_in">stdout</span>);</span><br><span class="line">        oS = obuff;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="class"><span class="keyword">class</span> <span class="title">Type</span>&gt;</span></span><br><span class="line"><span class="class">    <span class="title">inline</span> <span class="title">void</span> <span class="title">read</span>(<span class="title">Type</span>&amp; <span class="title">x</span>) &#123;</span></span><br><span class="line">        x = <span class="number">0</span>;</span><br><span class="line">        Type y = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">for</span> (c = gc(); (c &gt; <span class="string">'9'</span> || c &lt; <span class="string">'0'</span>) &amp;&amp; c ^ <span class="string">'-'</span>; c = gc())</span><br><span class="line">            ;</span><br><span class="line">        c == <span class="string">'-'</span> ? y = <span class="number">-1</span> : x = (c &amp; <span class="number">15</span>);</span><br><span class="line">        <span class="keyword">for</span> (c = gc(); c &gt;= <span class="string">'0'</span> &amp;&amp; c &lt;= <span class="string">'9'</span>; c = gc()) x = x * <span class="number">10</span> + (c &amp; <span class="number">15</span>);</span><br><span class="line">        x *= y;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">inline</span> <span class="keyword">bool</span> <span class="title">blank</span><span class="params">(<span class="keyword">char</span> ch)</span> </span>&#123; <span class="keyword">return</span> ch == <span class="string">' '</span> || ch == <span class="string">'\n'</span> || ch == <span class="string">'\r'</span> || ch == <span class="string">'\t'</span>; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">read</span><span class="params">(<span class="keyword">char</span>* s)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">register</span> <span class="keyword">char</span> ch = gc();</span><br><span class="line">        <span class="keyword">for</span> (; blank(ch); ch = gc())</span><br><span class="line">            ;</span><br><span class="line">        <span class="keyword">for</span> (; !blank(ch); ch = gc()) *s++ = ch;</span><br><span class="line">        *s = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">read</span><span class="params">(<span class="keyword">char</span>&amp; c)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (c = gc(); blank(c); c = gc())</span><br><span class="line">            ;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">typename</span> Type, <span class="keyword">typename</span>... Args&gt;</span><br><span class="line">    <span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">read</span><span class="params">(Type&amp; t, Args&amp;... args)</span> </span>&#123;</span><br><span class="line">        read(t), read(args...);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">typename</span>... Args&gt;</span><br><span class="line">    <span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">read</span><span class="params">(<span class="keyword">char</span>* t, Args&amp;... args)</span> </span>&#123;</span><br><span class="line">        read(t), read(args...);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">typename</span>... Args&gt;</span><br><span class="line">    <span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">read</span><span class="params">(<span class="keyword">char</span>&amp; t, Args&amp;... args)</span> </span>&#123;</span><br><span class="line">        read(t), read(args...);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="class"><span class="keyword">class</span> <span class="title">Type</span>&gt;</span></span><br><span class="line"><span class="class">    <span class="title">inline</span> <span class="title">void</span> <span class="title">write</span>(<span class="title">char</span> <span class="title">lastChar</span>, <span class="title">Type</span> <span class="title">x</span>) &#123;</span></span><br><span class="line">        <span class="keyword">if</span> (x &lt; <span class="number">0</span>)</span><br><span class="line">            *oS++ = <span class="string">'-'</span>, x = -x;</span><br><span class="line">        <span class="keyword">if</span> (x == <span class="number">0</span>)</span><br><span class="line">            *oS++ = <span class="string">'0'</span>;</span><br><span class="line">        <span class="keyword">while</span> (x) fu[++fr] = x % <span class="number">10</span> + <span class="string">'0'</span>, x /= <span class="number">10</span>;</span><br><span class="line">        <span class="keyword">while</span> (fr) *oS++ = fu[fr--];</span><br><span class="line">        *oS++ = lastChar;</span><br><span class="line">        ioout();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(<span class="keyword">char</span> lastChar, <span class="keyword">char</span> x[])</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">register</span> __int64 i = <span class="number">0</span>; x[i]; ++i) *oS++ = x[i];</span><br><span class="line">        *oS++ = lastChar;</span><br><span class="line">        ioout();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(<span class="keyword">char</span> lastChar, <span class="keyword">char</span> x)</span> </span>&#123;</span><br><span class="line">        *oS++ = x;</span><br><span class="line">        *oS++ = lastChar;</span><br><span class="line">        ioout();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">typename</span> Type, <span class="keyword">typename</span>... Args&gt;</span><br><span class="line">    <span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(<span class="keyword">char</span> midChar, Type t, Args... args)</span> </span>&#123;</span><br><span class="line">        write(midChar, t), write(midChar, args...);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;  <span class="comment">// namespace Fast_IO</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> Fast_IO::read;</span><br><span class="line"><span class="keyword">using</span> Fast_IO::write;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> __int64 SIZE = <span class="number">1e6</span> + <span class="number">5</span>;</span><br><span class="line"><span class="keyword">const</span> __int64 INF = <span class="number">0x7fffffff</span>;</span><br><span class="line">__int64 a[SIZE], bit[SIZE];</span><br><span class="line">__int64 dp[SIZE], n, k, T;</span><br><span class="line"><span class="built_in">vector</span> &lt; __int64 &gt; disc;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">add</span><span class="params">(__int64 x, __int64 y)</span> </span>&#123; <span class="keyword">for</span> (; x &gt; <span class="number">0</span>; x -= x &amp; -x) bit[x] = max(bit[x], y); &#125;</span><br><span class="line"><span class="function">__int64 <span class="title">ask</span><span class="params">(__int64 x, __int64 lim, __int64 res = -INF)</span> </span>&#123; <span class="keyword">for</span> (; x &lt; lim; x += x &amp; -x) res = max(res, bit[x]); <span class="keyword">return</span> res; &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Discretization</span><span class="params">(__int64 x)</span> </span>&#123;</span><br><span class="line">	disc.clear();</span><br><span class="line">	disc.pb(<span class="number">0</span>);</span><br><span class="line">	<span class="keyword">for</span> (__int64 i = <span class="number">1</span>; i &lt;= n; ++i) disc.pb(a[i]);</span><br><span class="line">	sort(disc.begin(), disc.end());</span><br><span class="line">	disc.erase(unique(disc.begin(), disc.end()), disc.end());</span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">Check</span><span class="params">(__int64 x)</span> </span>&#123;</span><br><span class="line">	Discretization(x);</span><br><span class="line">	<span class="keyword">for</span> (__int64 i = <span class="number">1</span>; i &lt;= (__int64)disc.size(); ++i) &#123;</span><br><span class="line">		<span class="keyword">for</span> (__int64 j = i; j &lt; (__int64)disc.size(); j += j &amp; -j) bit[i] = -INF;</span><br><span class="line">		<span class="keyword">for</span> (__int64 j = i; j &gt; <span class="number">0</span>; j -= j &amp; -j) bit[i] = -INF;</span><br><span class="line">	&#125;</span><br><span class="line">	*dp = <span class="number">0</span>;</span><br><span class="line">	add(lower_bound(disc.begin(), disc.end(), <span class="number">0</span>) - disc.begin() + <span class="number">1</span>, *dp);</span><br><span class="line">	<span class="keyword">for</span> (__int64 i = <span class="number">1</span>; i &lt;= n; ++i) &#123;</span><br><span class="line">		dp[i] = ask(lower_bound(disc.begin(), disc.end(), a[i] - x) - disc.begin() + <span class="number">1</span>, disc.size() + <span class="number">1</span>) + <span class="number">1</span>;</span><br><span class="line">		add(lower_bound(disc.begin(), disc.end(), a[i]) - disc.begin() + <span class="number">1</span>, dp[i]);</span><br><span class="line">		<span class="keyword">if</span> (k &lt;= dp[i]) <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">signed</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">for</span> (read(T); T; --T) &#123;</span><br><span class="line">		read(n, k);</span><br><span class="line">		<span class="keyword">for</span> (__int64 i = <span class="number">1</span>; i &lt;= n; ++i) read(a[i]), a[i] += a[i - <span class="number">1</span>];</span><br><span class="line">		__int64 l = -INF * SIZE, r = SIZE * INF;</span><br><span class="line">		<span class="keyword">while</span> (l &lt; r - <span class="number">1</span>)</span><br><span class="line">			<span class="keyword">if</span> (Check(mid)) r = mid;</span><br><span class="line">			<span class="keyword">else</span> l = mid;</span><br><span class="line">		write(io_l, r);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="28-P2163-SHOI2007-园丁的烦恼"><a href="#28-P2163-SHOI2007-园丁的烦恼" class="headerlink" title="28.P2163 [SHOI2007]园丁的烦恼"></a>28.P2163 [SHOI2007]园丁的烦恼</h1><p>很久很久以前，在遥远的大陆上有一个美丽的国家。统治着这个美丽国家的国王是一个园艺爱好者，在他的皇家花园里种植着各种奇花异草。</p>
<p>有一天国王漫步在花园里，若有所思，他问一个园丁道： “最近我在思索一个问题，如果我们把花坛摆成六个六角形，那么……”</p>
<p>“那么本质上它是一个深度优先搜索，陛下”，园丁深深地向国王鞠了一躬。</p>
<p>“嗯……我听说有一种怪物叫九头蛇，它非常贪吃苹果树……”</p>
<p>“是的，显然这是一道经典的动态规划题，早在N元4002年我们就已经发现了其中的奥秘了，陛下”。</p>
<p>“该死的，你究竟是什么来头？”</p>
<p>“陛下息怒，干我们的这行经常莫名其妙地被问到和OI有关的题目，我也是为了预防万一啊！” 王者的尊严受到了伤害，这是不可容忍的。</p>
<p>看来一般的难题是难不倒这位园丁的，国王最后打算用车轮战来消耗他的实力： “年轻人，在我的花园里的每一棵树可以用一个整数坐标来表示，一会儿，我的骑士们会来轮番询问你某一个矩阵内有多少树，如果你不能立即答对，你就准备走人吧！”说完，国王气呼呼地先走了。</p>
<p>这下轮到园丁傻眼了，他没有准备过这样的问题。所幸的是，作为“全国园丁保护联盟”的会长——你，可以成为他的最后一根救命稻草。</p>
<hr>
<p>。。。居然没有看到主席树题解。</p>
<p>这差不多就是一道主席树的板题了。</p>
<p>首先对x排序，然后动态开点一个一个的insert进去。</p>
<p>对于询问直接就二分取出横轴的范围l和r</p>
<p>然后询问root[r]-root[l-1]就好了</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> GCC diagnostic <span class="meta-keyword">error</span> <span class="meta-string">"-std=c++11"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstdio&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;algorithm&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstring&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;queue&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ls (data[rt].l)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> rs (data[rt].r)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SIZE_CHECKER(x, y) ((size[son[x]] &lt; size[y]) &amp;&amp; (son[x] = y))</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PII pair <span class="meta-string">&lt; int , int &gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PLL pair <span class="meta-string">&lt; LL, LL &gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> mid ((l + r) &gt;&gt; 1)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> mp make_pair</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> fir first</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> sec second</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> pb push_back</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> R register</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> __int8</span></span><br><span class="line">	<span class="keyword">typedef</span> <span class="keyword">char</span> __int8;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> __uint8</span></span><br><span class="line">	<span class="keyword">typedef</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> __uint8;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> __int16</span></span><br><span class="line">	<span class="keyword">typedef</span> short __int16;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> __uint16</span></span><br><span class="line">	<span class="keyword">typedef</span> <span class="keyword">unsigned</span> short __uint16;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> __int32</span></span><br><span class="line">	<span class="keyword">typedef</span> <span class="keyword">int</span> __int32;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> __int64</span></span><br><span class="line">	<span class="keyword">typedef</span> <span class="keyword">long</span> <span class="keyword">long</span> __int64;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> __uint32</span></span><br><span class="line">	<span class="keyword">typedef</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> __uint32;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> __uint64</span></span><br><span class="line">	<span class="keyword">typedef</span> <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> __uint64;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> io_e <span class="meta-string">'\0'</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> io_s <span class="meta-string">' '</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> io_l <span class="meta-string">'\n'</span></span></span><br><span class="line"> <span class="meta">#<span class="meta-keyword">define</span> _DEBUG_ 1 <span class="comment">// debug toggle</span></span></span><br><span class="line"><span class="keyword">namespace</span> Fast_IO &#123;</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">ifndef</span> _DEBUG_</span></span><br><span class="line">        <span class="meta">#<span class="meta-keyword">define</span> gc() (iS == iT ? (iT = (iS = ibuff) + fread(ibuff, 1, SIZ, stdin), (iS == iT ? EOF : *iS++)) : *iS++)</span></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">        <span class="meta">#<span class="meta-keyword">define</span> gc() getchar()</span></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">int</span> SIZ = <span class="number">1</span> &lt;&lt; <span class="number">21</span> | <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">char</span> *iS, *iT, ibuff[SIZ], obuff[SIZ], *oS = obuff, *oT = oS + SIZ - <span class="number">1</span>, fu[<span class="number">110</span>], c;</span><br><span class="line">    <span class="keyword">int</span> fr;</span><br><span class="line">    <span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">ioout</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        fwrite(obuff, <span class="number">1</span>, oS - obuff, <span class="built_in">stdout</span>);</span><br><span class="line">        oS = obuff;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="class"><span class="keyword">class</span> <span class="title">Type</span>&gt;</span></span><br><span class="line"><span class="class">    <span class="title">inline</span> <span class="title">void</span> <span class="title">read</span>(<span class="title">Type</span>&amp; <span class="title">x</span>) &#123;</span></span><br><span class="line">        x = <span class="number">0</span>;</span><br><span class="line">        Type y = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">for</span> (c = gc(); (c &gt; <span class="string">'9'</span> || c &lt; <span class="string">'0'</span>) &amp;&amp; c ^ <span class="string">'-'</span>; c = gc())</span><br><span class="line">            ;</span><br><span class="line">        c == <span class="string">'-'</span> ? y = <span class="number">-1</span> : x = (c &amp; <span class="number">15</span>);</span><br><span class="line">        <span class="keyword">for</span> (c = gc(); c &gt;= <span class="string">'0'</span> &amp;&amp; c &lt;= <span class="string">'9'</span>; c = gc()) x = x * <span class="number">10</span> + (c &amp; <span class="number">15</span>);</span><br><span class="line">        x *= y;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">inline</span> <span class="keyword">bool</span> <span class="title">blank</span><span class="params">(<span class="keyword">char</span> ch)</span> </span>&#123; <span class="keyword">return</span> ch == <span class="string">' '</span> || ch == <span class="string">'\n'</span> || ch == <span class="string">'\r'</span> || ch == <span class="string">'\t'</span>; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">read</span><span class="params">(<span class="keyword">char</span>* s)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">register</span> <span class="keyword">char</span> ch = gc();</span><br><span class="line">        <span class="keyword">for</span> (; blank(ch); ch = gc())</span><br><span class="line">            ;</span><br><span class="line">        <span class="keyword">for</span> (; !blank(ch); ch = gc()) *s++ = ch;</span><br><span class="line">        *s = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">read</span><span class="params">(<span class="keyword">char</span>&amp; c)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (c = gc(); blank(c); c = gc())</span><br><span class="line">            ;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">typename</span> Type, <span class="keyword">typename</span>... Args&gt;</span><br><span class="line">    <span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">read</span><span class="params">(Type&amp; t, Args&amp;... args)</span> </span>&#123;</span><br><span class="line">        read(t), read(args...);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">typename</span>... Args&gt;</span><br><span class="line">    <span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">read</span><span class="params">(<span class="keyword">char</span>* t, Args&amp;... args)</span> </span>&#123;</span><br><span class="line">        read(t), read(args...);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">typename</span>... Args&gt;</span><br><span class="line">    <span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">read</span><span class="params">(<span class="keyword">char</span>&amp; t, Args&amp;... args)</span> </span>&#123;</span><br><span class="line">        read(t), read(args...);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="class"><span class="keyword">class</span> <span class="title">Type</span>&gt;</span></span><br><span class="line"><span class="class">    <span class="title">inline</span> <span class="title">void</span> <span class="title">write</span>(<span class="title">char</span> <span class="title">lastChar</span>, <span class="title">Type</span> <span class="title">x</span>) &#123;</span></span><br><span class="line">        <span class="keyword">if</span> (x &lt; <span class="number">0</span>)</span><br><span class="line">            *oS++ = <span class="string">'-'</span>, x = -x;</span><br><span class="line">        <span class="keyword">if</span> (x == <span class="number">0</span>)</span><br><span class="line">            *oS++ = <span class="string">'0'</span>;</span><br><span class="line">        <span class="keyword">while</span> (x) fu[++fr] = x % <span class="number">10</span> + <span class="string">'0'</span>, x /= <span class="number">10</span>;</span><br><span class="line">        <span class="keyword">while</span> (fr) *oS++ = fu[fr--];</span><br><span class="line">        *oS++ = lastChar;</span><br><span class="line">        ioout();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(<span class="keyword">char</span> lastChar, <span class="keyword">char</span> x[])</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">register</span> <span class="keyword">int</span> i = <span class="number">0</span>; x[i]; ++i) *oS++ = x[i];</span><br><span class="line">        *oS++ = lastChar;</span><br><span class="line">        ioout();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(<span class="keyword">char</span> lastChar, <span class="keyword">char</span> x)</span> </span>&#123;</span><br><span class="line">        *oS++ = x;</span><br><span class="line">        *oS++ = lastChar;</span><br><span class="line">        ioout();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">typename</span> Type, <span class="keyword">typename</span>... Args&gt;</span><br><span class="line">    <span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(<span class="keyword">char</span> midChar, Type t, Args... args)</span> </span>&#123;</span><br><span class="line">        write(midChar, t), write(midChar, args...);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;  <span class="comment">// namespace Fast_IO</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> Fast_IO::read;</span><br><span class="line"><span class="keyword">using</span> Fast_IO::write;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> SIZE = <span class="number">5e5</span> + <span class="number">5</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> INF = <span class="number">1e7</span>;</span><br><span class="line"><span class="keyword">int</span> n, m, tot, rt[SIZE];</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">TreeNode</span> &#123;</span></span><br><span class="line">	<span class="keyword">int</span> l, r;</span><br><span class="line">	<span class="keyword">int</span> sum;</span><br><span class="line">&#125; data[SIZE &lt;&lt; <span class="number">5</span>];</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">TwoNode</span> &#123;</span></span><br><span class="line">	<span class="keyword">int</span> x, y;</span><br><span class="line">&#125; ints[SIZE];</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">BinarySeach</span> &#123;</span></span><br><span class="line">	<span class="function"><span class="keyword">int</span> <span class="title">upper_bound</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">int</span> l = <span class="number">1</span>, r = n + <span class="number">1</span>;</span><br><span class="line">		<span class="keyword">while</span> (l &lt; r - <span class="number">1</span>) <span class="keyword">if</span> (ints[mid].x &gt; x) r = mid; <span class="keyword">else</span> l = mid;</span><br><span class="line">		<span class="keyword">return</span> l;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">int</span> <span class="title">lower_bound</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">int</span> l = <span class="number">0</span>, r = n;</span><br><span class="line">		<span class="keyword">while</span> (l &lt; r - <span class="number">1</span>) <span class="keyword">if</span> (ints[mid].x &gt;= x) r = mid; <span class="keyword">else</span> l = mid;</span><br><span class="line">		<span class="keyword">return</span> r;</span><br><span class="line">	&#125;</span><br><span class="line">&#125; BS;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">cmp</span><span class="params">(<span class="keyword">const</span> TwoNode&amp; x, <span class="keyword">const</span> TwoNode&amp; y)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> x.x &lt; y.x;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">update</span><span class="params">(<span class="keyword">int</span> &amp;rt, <span class="keyword">int</span> l, <span class="keyword">int</span> r, <span class="keyword">int</span> x)</span> </span>&#123;</span><br><span class="line">	data[++tot] = data[rt];</span><br><span class="line">	++data[rt = tot].sum;</span><br><span class="line">	<span class="keyword">if</span> (l ^ r) <span class="keyword">if</span> (mid &gt;= x) update(ls, l, mid, x); <span class="keyword">else</span> update(rs, mid + <span class="number">1</span>, r, x); <span class="keyword">else</span> <span class="keyword">return</span> ;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">queryf</span><span class="params">(<span class="keyword">int</span> rt, <span class="keyword">int</span> l, <span class="keyword">int</span> r, <span class="keyword">int</span> x, <span class="keyword">int</span> y)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (l &gt; y || r &lt; x || !rt) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (l &gt;= x &amp;&amp; r &lt;= y) <span class="keyword">return</span> data[rt].sum;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">return</span> queryf(ls, l, mid, x, y) + queryf(rs, mid + <span class="number">1</span>, r, x, y);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">signed</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	read(n, m);</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; ++i) read(ints[i].x, ints[i].y);</span><br><span class="line">	sort(ints + <span class="number">1</span>, ints + <span class="number">1</span> + n, cmp);</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; ++i) update(rt[i] = rt[i - <span class="number">1</span>], <span class="number">0</span>, INF, ints[i].y);</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>, a, b, c, d; i &lt;= m; ++i) &#123;</span><br><span class="line">		read(a, b, c, d);</span><br><span class="line">		write(io_l, queryf(rt[BS.upper_bound(c)], <span class="number">0</span>, INF, b, d) - queryf(rt[BS.lower_bound(a) - <span class="number">1</span>], <span class="number">0</span>, INF, b, d));</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="29-P5220-特工的信息流"><a href="#29-P5220-特工的信息流" class="headerlink" title="29.P5220 特工的信息流"></a>29.P5220 特工的信息流</h1><p>$\text{TYM}$ 所在的国家有 $n$ 个城市，编号为 $1,\dots,n$，由 $n - 1$ 条双向道路连接。保证任意两个城市间都有唯一的简单路径。<br>以及，每个城市都有一个信息流的流量 $a_i$。</p>
<p>$\text{TYM}$ 一共要执行 $m_0$ 个任务，每个任务给定两个城市 $s,t$，其执行过程如下：<br>第一个时刻，他从城市 $s$ 出发，以每个时刻移动到下一个城市的速度，走 $s,t$ 之间的简单路径到 $t$。<br>每到达一个城市，他都会把这个城市的信息流 $a_i$ 发送到经过的每个城市。<br>我们约定，他到达一个城市的同一时刻也会把这个城市的信息流发送给这个城市。我们定义一个城市的价值为这个城市所接受到的信息流的乘积。</p>
<p>请你求出每个任务中，$s$ 到 $t$ 的简单路径上经过的城市的价值的总和对 $20924$ 取模的结果。</p>
<p>此外，不幸地，由于侵略者同时也在行动，所以在他执行多个任务之间，可能会有某个 $a_i$ 发生改变。</p>
<p>他的任务总数与改变某个 $a_i$ 的次数之和为 $m$。</p>
<hr>
<h3 id="WGY：LCT"><a href="#WGY：LCT" class="headerlink" title="WGY：LCT"></a>WGY：LCT</h3><p>这道题的题意是真的绕，我前前后后读了不下五遍才大概意会。。。</p>
<p>做数据结构的题一般都要先浓缩题意。这道题是让我们求后缀积之和，再加上修改操作就基本上确定用LCT了</p>
<p>需要维护的信息有前缀积之和,后缀积之和，区间乘法三个信息。</p>
<p>对于修改操作，直接上LCT的套路makeroot和access。</p>
<p>对于询问操作，我们直接按照LCT的套路用makeroot和access把链给搞出来。</p>
<p>其实这就相当于一道LCT的板题吧。。。全部都是基础操作。。。</p>
<p>完整代码在这里<a href="https://paste.ubuntu.com/p/tsQ43Pvvg6/" target="_blank" rel="noopener">Link</a></p>
<p>如果链接失效了就这个<a href="https://www.luogu.com.cn/paste/gtishzfw" target="_blank" rel="noopener">Link</a></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> SIZE = <span class="number">1e5</span> + <span class="number">5</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> M_SIZE = <span class="number">2e5</span> + <span class="number">5</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> MOD = <span class="number">20924</span>;</span><br><span class="line"><span class="keyword">int</span> head[M_SIZE], nxt[M_SIZE];</span><br><span class="line"><span class="keyword">int</span> to[M_SIZE], ints[SIZE];</span><br><span class="line"><span class="keyword">int</span> waste[SIZE], n, m, top, tot;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">SPLAY</span> &#123;</span></span><br><span class="line">	<span class="keyword">int</span> fa;</span><br><span class="line">	<span class="keyword">int</span> ch[<span class="number">2</span>];</span><br><span class="line">	<span class="keyword">int</span> prod;</span><br><span class="line">	<span class="keyword">int</span> preprod;</span><br><span class="line">	<span class="keyword">int</span> sufprod;</span><br><span class="line">	<span class="keyword">int</span> lztg;</span><br><span class="line">&#125; data[SIZE];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">AddEdge</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y)</span> </span>&#123;</span><br><span class="line">	to[++tot] = y;</span><br><span class="line">	nxt[tot] = head[x];</span><br><span class="line">	head[x] = tot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">IsRoot</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> ((data[data[x].fa].ch[<span class="number">1</span>] ^ x) &amp;&amp; (data[data[x].fa].ch[<span class="number">0</span>] ^ x));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">WhichSon</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> (data[data[x].fa].ch[<span class="number">1</span>] == x);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UpdateMessages</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</span><br><span class="line">	data[x].prod = data[data[x].ch[<span class="number">0</span>]].prod * data[data[x].ch[<span class="number">1</span>]].prod % MOD * ints[x] % MOD;</span><br><span class="line">	data[x].preprod = (data[data[x].ch[<span class="number">0</span>]].preprod + data[data[x].ch[<span class="number">0</span>]].prod * ints[x] + data[data[x].ch[<span class="number">0</span>]].prod * ints[x] % MOD * data[data[x].ch[<span class="number">1</span>]].preprod) % MOD;</span><br><span class="line">	data[x].sufprod = (data[data[x].ch[<span class="number">1</span>]].sufprod + data[data[x].ch[<span class="number">1</span>]].prod * ints[x] + data[data[x].ch[<span class="number">1</span>]].prod * ints[x] % MOD * data[data[x].ch[<span class="number">0</span>]].sufprod) % MOD;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UpdateSons</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (data[x].lztg) &#123;</span><br><span class="line">		swap(data[data[x].ch[<span class="number">0</span>]].ch[<span class="number">0</span>], data[data[x].ch[<span class="number">0</span>]].ch[<span class="number">1</span>]);</span><br><span class="line">		swap(data[data[x].ch[<span class="number">1</span>]].ch[<span class="number">0</span>], data[data[x].ch[<span class="number">1</span>]].ch[<span class="number">1</span>]);</span><br><span class="line">		swap(data[data[x].ch[<span class="number">0</span>]].preprod, data[data[x].ch[<span class="number">0</span>]].sufprod);</span><br><span class="line">		swap(data[data[x].ch[<span class="number">1</span>]].preprod, data[data[x].ch[<span class="number">1</span>]].sufprod);</span><br><span class="line">		data[data[x].ch[<span class="number">0</span>]].lztg ^= <span class="number">1</span>;</span><br><span class="line">		data[data[x].ch[<span class="number">1</span>]].lztg ^= <span class="number">1</span>;</span><br><span class="line">		data[x].lztg = <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">RotateNode</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">int</span> y = data[x].fa;</span><br><span class="line">	<span class="keyword">int</span> z = data[y].fa;</span><br><span class="line">	<span class="keyword">int</span> k = WhichSon(x);</span><br><span class="line">	<span class="keyword">if</span> (!IsRoot(y)) data[z].ch[WhichSon(y)] = x;</span><br><span class="line">	data[y].fa = x;</span><br><span class="line">	data[data[y].fa].fa = z;</span><br><span class="line">	<span class="keyword">if</span> (data[x].ch[k ^ <span class="number">1</span>]) data[data[x].ch[k ^ <span class="number">1</span>]].fa = y;</span><br><span class="line">	data[y].ch[k] = data[x].ch[k ^ <span class="number">1</span>];</span><br><span class="line">	data[x].ch[k ^ <span class="number">1</span>] = y;</span><br><span class="line">	UpdateMessages(y);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">SplayToRoot</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">int</span> y = waste[top = <span class="number">1</span>] = x;</span><br><span class="line">	<span class="keyword">while</span> (!IsRoot(y)) waste[++top] = y = data[y].fa;</span><br><span class="line">	<span class="keyword">while</span> (top) UpdateSons(waste[top--]);</span><br><span class="line">	<span class="keyword">for</span> (; !IsRoot(x); RotateNode(x))</span><br><span class="line">		<span class="keyword">if</span> (!IsRoot((y = data[x].fa)))</span><br><span class="line">			RotateNode((data[data[y].fa].ch[<span class="number">1</span>] ^ y ^ data[y].ch[<span class="number">1</span>] ^ x) ? x : y);</span><br><span class="line">	UpdateMessages(x);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">AccessEdge</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> y = <span class="number">0</span>; x; x = data[y = x].fa) &#123;</span><br><span class="line">		SplayToRoot(x);</span><br><span class="line">		data[x].ch[<span class="number">1</span>] = y;</span><br><span class="line">		UpdateMessages(x);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">MakeRoot</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</span><br><span class="line">	AccessEdge(x);</span><br><span class="line">	SplayToRoot(x);</span><br><span class="line">	swap(data[x].ch[<span class="number">0</span>], data[x].ch[<span class="number">1</span>]);</span><br><span class="line">	swap(data[x].preprod, data[x].sufprod);</span><br><span class="line">	data[x].lztg ^= <span class="number">1</span>;</span><br><span class="line">	UpdateMessages(x);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">SplitTree</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y)</span> </span>&#123;</span><br><span class="line">	MakeRoot(x);</span><br><span class="line">	AccessEdge(y);</span><br><span class="line">	SplayToRoot(y);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Prepare</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</span><br><span class="line">	data[x].prod = ints[x];</span><br><span class="line">	data[x].preprod = ints[x];</span><br><span class="line">	data[x].sufprod = ints[x];</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = head[x]; i; i = nxt[i])</span><br><span class="line">		<span class="keyword">if</span> (to[i] ^ data[x].fa)</span><br><span class="line">			data[to[i]].fa = x, Prepare(to[i]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">GetAnswers</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y)</span> </span>&#123;</span><br><span class="line">	SplitTree(x, y);</span><br><span class="line">	UpdateSons(y);</span><br><span class="line">	<span class="keyword">return</span> data[y].sufprod;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Behavior</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y)</span> </span>&#123;</span><br><span class="line">	SplitTree(x, x);</span><br><span class="line">	ints[x] += y;</span><br><span class="line">	ints[x] %= MOD;</span><br><span class="line">	data[x].prod = ints[x];</span><br><span class="line">	data[x].preprod = ints[x];</span><br><span class="line">	data[x].sufprod = ints[x];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">signed</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	read(n, m);</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; ++i) read(ints[i]);</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>, x, y; i &lt; n; ++i) read(x, y), AddEdge(x, y), AddEdge(y, x);</span><br><span class="line">	(*data).prod = <span class="number">1</span>;</span><br><span class="line">	Prepare(<span class="number">1</span>);</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, x, y; i &lt; m; ++i) &#123;</span><br><span class="line">		<span class="keyword">char</span> opt[<span class="number">5</span>];</span><br><span class="line">		read(opt);</span><br><span class="line">		read(x, y);</span><br><span class="line">		<span class="keyword">if</span> (*opt ^ <span class="string">'C'</span>) write(io_l, GetAnswers(x, y));</span><br><span class="line">		<span class="keyword">else</span> Behavior(x, y);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="LYC-TCS"><a href="#LYC-TCS" class="headerlink" title="LYC:TCS"></a>LYC:TCS</h3>
          
            <hr>
            <center><img class="lazyload" onerror="imgError(this,3)" src="https://cdn.jsdelivr.net/gh/ctz45562/cdn@1.7.9/lazyload.gif" data-src="https://cdn.jsdelivr.net/gh/ctz45562/cdn@2.0.3/emojis/gif/23.gif"></center>
            <p style="font-size:32px;text-align:center;margin-top:-2px">施工中...</p>
                        
        </div>
        <!-- .entry-content -->
        <!-- <div class="single-reward">
          <div class="reward-open">赏
            <div class="reward-main">
              <ul class="reward-row">
                <li class="alipay-code"><img src="/img/custom/donate/AliPayQR.jpg"></li>
                <li class="wechat-code"><img src="/img/custom/donate/WeChanQR.jpg"></li>
              </ul>
            </div>
          </div>
        </div>
        <div style="text-align:center; width: 100%" class="social-share share-mobile" data-disabled="diandian, tencent"></div>
        <footer class="post-footer">
          <div class="post-lincenses"><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" rel="nofollow"><i class="fa fa-creative-commons" aria-hidden="true"></i> 知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议</a></div>
          <div class="post-tags">
          </div>
          <div class="post-share">
            <div class="social-share sharehidden share-component"></div>
            <i class="iconfont show-share icon-forward"></i>
          </div>
        </footer>. -->
        <!-- entry-footer -->
      </article>
      <!-- #post-## -->
      <div class="toc" style="background: none;"></div>
      <section class="post-squares nextprev">
        
          
            <div class="post-nepre half previous">
          
            <a href="/2020/02/08/DS100P-31-40-P/" rel="prev">
              <div class="background">
                <img class="lazyload" src="https://cdn.jsdelivr.net/gh/honjun/cdn@1.6/img/loader/orange.progress-bar-stripe-loader.svg" data-src="https://i.loli.net/2020/02/08/oC8G7Zu2UknzYpJ.jpg" style="width: 100%; height: 100%; object-fit: cover; pointer-events: none;" onerror="imgError(this,3)" src="https://i.loli.net/2020/02/08/oC8G7Zu2UknzYpJ.jpg">
              </div>
              <span class="label">
              Previous Post</span>
              <div class="info">
                <h3>
                数据结构100题 31~40题</h3>
              </div>
            </a>
          </div>
        
        
          
            <div class="post-nepre half next">
          
            <a href="/2020/02/08/DS100P-11-20-P/" rel="next">
              <div class="background">
                <img class="lazyload" src="https://cdn.jsdelivr.net/gh/honjun/cdn@1.6/img/loader/orange.progress-bar-stripe-loader.svg" data-src="https://i.loli.net/2020/02/08/xTNR8Kl3C7IiYd6.jpg" style="width: 100%; height: 100%; object-fit: cover; pointer-events: none;" onerror="imgError(this,3)" src="https://i.loli.net/2020/02/08/xTNR8Kl3C7IiYd6.jpg">
              </div>
              <span class="label">
              Next Post</span>
              <div class="info">
                <h3>
                数据结构100题 11~20题</h3>
              </div>
            </a>
          </div>
        
      </section>
      
<div id="vcomments"></div>
<script>
  window.onload = function(){
      var valine = new Valine();
      valine.init({
        el: '#vcomments',
        appId: "8Hho6gvnedMT9NMEhnEx3UOg-gzGzoHsz",
        appKey: "gU70zYoblzxCmc6iL697pp69",
        path: window.location.pathname,
        placeholder: "Come And Get Your Love~"
      })
  }
</script>

      <section class="author-profile">
        <div class="info" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
          <a href="/" class="profile gravatar"><img src="https://i.loli.net/2020/02/06/fuc7zI8iylU5ANt.jpg" itemprop="image" alt="BoringHacker" height="70" width="70"></a>
          <div class="meta">
            <span class="title">Author</span>
            <h3 itemprop="name">
            <a href="/" itemprop="url" rel="author">BoringHacker</a>
            </h3>
          </div>
        </div>
        <hr>
        <p><i class="iconfont icon-write"></i>不会打DS的OIER不是萌妹子！</p>
      </section>
    </main><!-- #main -->
  </div><!-- #primary -->
</div>

<script>
  var spoiler=document.getElementsByClassName('spoiler');
  for(var i=0;i<spoiler.length;++i)
  spoiler[i].onclick=function(){this.classList.toggle("revealed");};
  </script>  


  <script type="text/javascript" src="https://cdn.bootcss.com/mathjax/2.7.6/latest.js?config=TeX-MML-AM_CHTML"></script>
  <script type="text/x-mathjax-config">
    MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}});
  </script>

    </div>    
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" placeholder="请输入关键词..."/>
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: '文章',
            // PAGES: '页面',
            CATEGORIES: '分类',
            TAGS: '标签',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>
    <!-- <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2020 BoringHacker<br>
      powered_by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer> -->
<footer id="colophon" class="site-footer" role="contentinfo">
  <div class="site-info">
    <div class="footertext">
      <div class="img-preload">
        <img src="https://cdn.jsdelivr.net/gh/honjun/cdn@1.6/img/other/wordpress-rotating-ball-o.svg">
        <img src="https://cdn.jsdelivr.net/gh/honjun/cdn@1.6/img/other/disqus-preloader.svg">
      </div>
      <p style="color: #666666;">&copy 2018</p>
    </div>
    <div class="footer-device">
    <p style="font-family: 'Ubuntu', sans-serif;">
        <span style="color: #b9b9b9;">Theme <a href="https://github.com/honjun/hexo-theme-sakura" target="_blank" style="color: #b9b9b9;;text-decoration: underline dotted rgba(0, 0, 0, .1);">Sakura</a> <i class="iconfont icon-sakura rotating" style="color: #ffc0cb;display:inline-block"></i> by <a href="https://2heng.xin/" target="_blank" style="color: #b9b9b9;;text-decoration: underline dotted rgba(0, 0, 0, .1);">Mashiro</a>&<a href="https://www.hojun.cn/" target="_blank" style="color: #b9b9b9;;text-decoration: underline dotted rgba(0, 0, 0, .1);">Hojun</a>, Powered by Hexo, Hosted by Coding Pages</a>
        </span>
      </p>
    </div>
  </div><!-- .site-info -->
</footer>



<!-- <script src="/js/tocbot.js"></script> -->
<script type="text/javascript" src="/js/lib.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js"></script>
<script type="text/javascript" src="/js/InsightSearch.js"></script>
<script type="text/javascript" src="/js/jquery.fancybox.min.js"></script>
<script type="text/javascript" src="/js/zoom.min.js"></script>
<script type="text/javascript" src="/js/sakura-app.js"></script>
<script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
<script src='//unpkg.com/valine@1.3.4/dist/Valine.min.js'></script>
<script src="/js/botui.js"></script>
<!-- 不蒜子 网页计数器 -->
<script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.min.js"></script> -->
<script type="text/javascript">
/* <![CDATA[ */
if (/Android|webOS|iPhone|iPod|BlackBerry/i.test(navigator.userAgent)) {
  var Poi = {"pjax":"1","movies":{"url": "https://cdn.jsdelivr.net/gh/honjun/hojun@1.2","name":"Unbroken.mp4","live":"close"},"windowheight":"fixed","codelamp":"close","ajaxurl":"","order":"asc","formpostion":"bottom"};
} else {
  var Poi = {"pjax":"1","movies":{"url": "https://cdn.jsdelivr.net/gh/honjun/hojun@1.2","name":"Unbroken.mp4","live":"open"},"windowheight":"auto","codelamp":"close","ajaxurl":"","order":"asc","formpostion":"bottom"};
}
/* ]]> */

</script>
<script>
$(document).ready(function() {
  if ($(".toc").length > 0 && document.body.clientWidth > 1200) {
    if ($(".pattern-center").length > 0) { //有图的情况
      tocbot.init({
          // Where to render the table of contents.
          tocSelector: '.toc', // 放置目录的容器
          // Where to grab the headings to build the table of contents.
          contentSelector: '.entry-content', // 正文内容所在
          // Which headings to grab inside of the contentSelector element.
          scrollSmooth: true,
          headingSelector: 'h1, h2, h3, h4, h5', // 需要索引的标题级别
          headingsOffset: -400,
          scrollSmoothOffset: -85
      });
    } else {
      tocbot.init({
          // Where to render the table of contents.
          tocSelector: '.toc', // 放置目录的容器
          // Where to grab the headings to build the table of contents.
          contentSelector: '.entry-content', // 正文内容所在
          // Which headings to grab inside of the contentSelector element.
          scrollSmooth: true,
          headingSelector: 'h1, h2, h3, h4, h5', // 需要索引的标题级别
          headingsOffset: -85,
          scrollSmoothOffset: -85
      });
    }
    var offsetTop = $('.toc').offset().top - 95;
    window.onscroll = function() {
      var scrollTop = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop;
      if (scrollTop >= offsetTop) {
        $('.toc').addClass('toc-fixed');
      } else {
        $('.toc').removeClass('toc-fixed');
      }
    }
  }
});
</script>

    <div class="openNav no-select" style="height: 50px;">
      <div class="iconflat no-select" style="width: 50px; height: 50px;">
        <div class="icon"></div>
      </div>
      <div class="site-branding search-form-submit">
        <i class="iconfont js-toggle-search iconsearch icon-search"></i>
      </div>
    </div>
  </section>
  <!-- <div id="mo-nav" class="">
  <div class="m-avatar">
    <img src="https://i.loli.net/2020/02/06/fuc7zI8iylU5ANt.jpg">
  </div>
  <p style="text-align: center; color: #333; font-weight: 900; font-family: 'Ubuntu', sans-serif; letter-spacing: 1.5px">BoringHacker'sBlog</p>
  <p style="text-align: center; word-spacing: 20px;">
    
      
        <a href="http://github.com/honjun" class="fa fa-github" target="_blank" style="color: #333; margin-left:20px"></a>
      
        <a href="http://weibo.com/mashirozx?is_all=1" class="fa fa-weibo" target="_blank" style="color: #dd4b39; margin-left:20px"></a>
      
        <a href="https://wpa.qq.com/msgrd?v=3&uin=954655431&site=qq&menu=yes" class="fa fa-qq" target="_blank" style="color: #25c6fe; margin-left:20px"></a>
      
    
  </p>
  <ul id="menu-new-1" class="menu">
    
      <li>
        <a href="/">
          <span class="faa-parent animated-hover">
            <i class="fa  fa-fort-awesome faa-shake" aria-hidden="true"></i>
            Home
          </span>
        </a>
        
      </li>
    
      <li>
        <a href="/archives">
          <span class="faa-parent animated-hover">
            <i class="fa  fa-archive faa-shake" aria-hidden="true"></i>
            Archives
          </span>
        </a>
        
          <ul class="sub-menu">
            
              <li>
                <a href="/categories/Note/">
                  <i class="fa fa-book" aria-hidden="true"></i>
                  Notes
                </a>
              </li>
            
              <li>
                <a href="/categories/Solution">
                  <i class="fa fa-code" aria-hidden="true"></i>
                  Solution
                </a>
              </li>
            
          </ul>
        
      </li>
    
      <li>
        <a href="javascript:;">
          <span class="faa-parent animated-hover">
            <i class="fa  fa-list-ul faa-vertical" aria-hidden="true"></i>
            Lists
          </span>
        </a>
        
          <ul class="sub-menu">
            
              <li>
                <a href="/tags/悦读/">
                  <i class="fa fa-th-list faa-bounce" aria-hidden="true"></i>
                  Books
                </a>
              </li>
            
              <li>
                <a href="/bangumi/">
                  <i class="fa fa-film faa-vertical" aria-hidden="true"></i>
                  Animes
                </a>
              </li>
            
          </ul>
        
      </li>
    
      <li>
        <a href="/comment/">
          <span class="faa-parent animated-hover">
            <i class="fa  fa-pencil-square-o faa-tada" aria-hidden="true"></i>
            Comments
          </span>
        </a>
        
      </li>
    
      <li>
        <a href="/links/">
          <span class="faa-parent animated-hover">
            <i class="fa  fa-link faa-shake" aria-hidden="true"></i>
            Links
          </span>
        </a>
        
      </li>
    
      <li>
        <a href="/Tools/">
          <span class="faa-parent animated-hover">
            <i class="fa  fa-cog" aria-hidden="true"></i>
            Tools
          </span>
        </a>
        
      </li>
    
      <li>
        <a href="/tags/">
          <span class="faa-parent animated-hover">
            <i class="fa  fa-tags" aria-hidden="true"></i>
            Tags
          </span>
        </a>
        
      </li>
    
      <li>
        <a href="/">
          <span class="faa-parent animated-hover">
            <i class="fa  fa-leaf faa-wrench" aria-hidden="true"></i>
            About
          </span>
        </a>
        
          <ul class="sub-menu">
            
              <li>
                <a href="/about/">
                  <i class="fa fa-meetup" aria-hidden="true"></i>
                  Me
                </a>
              </li>
            
              <li>
                <a href="/lab/">
                  <i class="fa fa-cogs" aria-hidden="true"></i>
                  Blog
                </a>
              </li>
            
          </ul>
        
      </li>
    
      <li>
        <a href="/atom.xml">
          <span class="faa-parent animated-hover">
            <i class="fa  fa-rss faa-pulse" aria-hidden="true"></i>
            RSS
          </span>
        </a>
        
      </li>
    
  </ul>
  <p style="text-align: center; font-size: 13px; color: #b9b9b9;">&copy 2019 hexo-sakura</p>
</div>
<button onclick="topFunction()" class="mobile-cd-top" id="moblieGoTop" title="Go to top" style="display: none;"><i class="fa fa-chevron-up" aria-hidden="true"></i></button>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css">
<script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script>
<!-- require MetingJS -->
<script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script>
<style>
  .aplayer .aplayer-lrc {
    height: 35px;
  }
  .aplayer .aplayer-lrc p{
    font-size: 16px;
    font-weight: 700;
    line-height: 18px !important;
  }
  .aplayer .aplayer-lrc p.aplayer-lrc-current{
    color: #FF1493;
  }
  .aplayer.aplayer-narrow .aplayer-body{
    left: -66px !important;
  }
  .aplayer.aplayer-fixed .aplayer-lrc {
    display: none;
  }
  .aplayer .aplayer-lrc.aplayer-lrc-hide {
      display:none !important;
  }
  .aplayer.aplayer-fixed .lrc-show {
    display: block;
    background: rgba(255, 255, 255, 0.8);
  }
</style>
<meting-js

    id="2660651585"

    server="netease"

    type="playlist"

    fixed="true"

    autoplay="false"

    loop="all"

    order="random"

    preload="auto"

    volume="0.7"

    mutex="true"

</meting-js>
<script>
  $(function(){
    $('body').on('click', '.aplayer', function(){
      if($('.aplayer-button').hasClass('aplayer-play')) {
        $('.aplayer-lrc').removeClass('lrc-show');
      } else {
        $('.aplayer-lrc').addClass('lrc-show');
      }
    })
  });
</script> -->
</body>
</html>